name: External Dependencies Integration

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  check-external-repos:
    name: Verify External Repositories
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Edge Craft
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Clone Core-Edge Server
        run: |
          git clone https://github.com/uz0/core-edge ../core-edge || {
            echo "::error::Failed to clone core-edge repository"
            exit 1
          }

      - name: Clone Index.EdgeCraft Launcher
        run: |
          git clone https://github.com/uz0/index.edgecraft ../index.edgecraft || {
            echo "::error::Failed to clone index.edgecraft repository"
            exit 1
          }

      - name: Test Core-Edge Integration
        run: |
          cd ../core-edge
          npm ci
          npm test

      - name: Test Launcher Integration
        run: |
          cd ../index.edgecraft
          npm ci
          npm run build

      - name: Integration Test
        run: |
          # Start core-edge in background
          cd ../core-edge
          npm run dev &
          CORE_EDGE_PID=$!

          # Wait for server to start
          sleep 10

          # Run integration tests
          cd ${{ github.workspace }}
          npm ci
          npm run test:integration

          # Cleanup
          kill $CORE_EDGE_PID

      - name: Report Status
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'External Dependencies Integration Failed',
              body: 'The daily external dependencies check has failed. Please review the workflow logs.',
              labels: ['external-deps', 'automated']
            });