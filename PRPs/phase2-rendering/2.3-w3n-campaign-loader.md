# PRP 2.3: W3N Campaign Loader Implementation

**Feature Name**: Warcraft 3 Campaign Format Support
**Duration**: 4-5 days | **Team**: 1 developer | **Budget**: $4,000
**Status**: 📋 Planned

**Dependencies**:
- PRP 2.10 (Map Streaming) - required for large files

---

## 🎯 Objective

Implement W3NCampaignLoader to parse Warcraft 3 campaign files (.w3n format), enabling loading of 7 campaign files (57MB - 923MB).

**Files to Support**:
- `SearchingForPower.w3n` (74MB)
- `Wrath of the Legion.w3n` (57MB)
- `War3Alternate1 - Undead.w3n` (106MB)
- `TheFateofAshenvaleBySvetli.w3n` (316MB)
- `BurdenOfUncrowned.w3n` (320MB)
- `HorrorsOfNaxxramas.w3n` (433MB)
- `JudgementOfTheDead.w3n` (923MB) ⚠️

---

## 📊 Current State

**✅ WORKING**: W3XMapLoader.ts, MPQParser.ts
**❌ MISSING**: W3NCampaignLoader.ts, campaign structure parsing

---

## 🔬 Research

**Source**: https://docs.fileformat.com/game/w3n/

**Key Findings**:
1. Same MPQ structure as W3X (512-byte header + 260-byte footer)
2. Contains `war3campaign.*` files instead of `war3map.*`
3. Multiple embedded maps (campaign progression)
4. Campaign-specific: `.w3u` (units), `.w3t` (tech), `.w3a` (abilities), `.w3f` (info)
5. Strategy: Extend W3XMapLoader, extract first map only (Phase 1)

---

## 📋 Definition of Done

- [ ] `W3NCampaignLoader.ts` created - extends W3XMapLoader
- [ ] Campaign metadata parser (`war3campaign.w3f`)
- [ ] Multi-map extraction logic
- [ ] Returns FIRST map in campaign (full progression = Phase 3)
- [ ] Streaming support for >100MB files (uses PRP 2.10)
- [ ] Registered in MapLoaderRegistry (`.w3n` extension)
- [ ] All 7 W3N files load successfully
- [ ] Performance: <5s for 100MB, <15s for 923MB
- [ ] Unit tests (>80% coverage)

---

## 💻 Implementation

```typescript
// src/formats/maps/w3n/W3NCampaignLoader.ts

import { W3XMapLoader } from '../w3x/W3XMapLoader';
import { MPQParser } from '../../mpq/MPQParser';
import type { IMapLoader, RawMapData } from '../types';

export class W3NCampaignLoader implements IMapLoader {
  private w3xLoader: W3XMapLoader;

  constructor() {
    this.w3xLoader = new W3XMapLoader();
  }

  public async parse(file: File | ArrayBuffer): Promise<RawMapData> {
    const buffer = file instanceof ArrayBuffer ? file : await file.arrayBuffer();

    const mpq = new MPQParser(buffer);
    const result = mpq.parse();

    if (!result.success) throw new Error('Failed to parse campaign');

    // Extract campaign info
    const campaignInfo = mpq.extractFile('war3campaign.w3f');

    // Extract first map (embedded MPQ within campaign MPQ)
    const maps = this.extractEmbeddedMaps(mpq);

    if (maps.length === 0) throw new Error('No maps in campaign');

    // Parse first map using W3XMapLoader
    return this.w3xLoader.parse(maps[0]);
  }

  private extractEmbeddedMaps(mpq: MPQParser): ArrayBuffer[] {
    // Campaign maps are stored as separate MPQs
    // Look for files matching *.w3x pattern
    const mapFiles = mpq.listFiles().filter(f => f.endsWith('.w3x'));
    return mapFiles.map(f => mpq.extractFile(f)!.data);
  }
}
```

**Pattern**: Follow W3XMapLoader.ts (lines 27-94)

---

## 🧪 Validation

```bash
npm run typecheck
npm test -- src/formats/maps/w3n/W3NCampaignLoader.test.ts
npm run test:w3n-campaigns  # Load all 7 files
```

**Expected**:
- ✅ All 7 W3N files load
- ✅ Load times: <5s for 100MB, <15s for 923MB
- ✅ Extracted map data valid

---

## 📦 Tasks (5 days)

**Day 1**: Setup + campaign info parser
**Day 2**: Multi-map extraction logic
**Day 3**: Integration with W3XMapLoader
**Day 4**: Streaming support for large files
**Day 5**: Testing + performance optimization

---

## 🚨 Risks

🔴 **High**: 923MB file may cause memory issues
**Mitigation**: Use PRP 2.10 streaming, chunk loading

🟡 **Medium**: Embedded map format variations
**Mitigation**: Test with all 7 files, handle edge cases

---

## 📚 References

- **W3N Format**: https://docs.fileformat.com/game/w3n/
- **Pattern**: src/formats/maps/w3x/W3XMapLoader.ts
- **Streaming**: Wait for PRP 2.10 or implement basic version

---

## 🎯 Confidence: **8.5/10**

Strong pattern to follow (W3X), clear structure. Main risk is 923MB file.
