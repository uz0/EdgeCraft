# PRP 2.11: Playwright E2E Testing Infrastructure

## Goal
Establish a comprehensive end-to-end testing infrastructure using Playwright for WebGL/Babylon.js map rendering with screenshot-based visual regression testing. Enable automated validation of map loading, rendering correctness, and visual quality across all supported formats (W3X, W3N, SC2Map).

## Why
- **Quality Assurance**: Catch visual regressions in Babylon.js rendering before production
- **Format Validation**: Ensure all 24 maps load and render correctly across formats
- **Performance Monitoring**: Track loading times and FPS for regression detection
- **CI/CD Integration**: Automated testing in GitHub Actions with Docker
- **Phase 2 Validation**: Verify advanced rendering features (post-processing, lighting, particles, weather)

## What
A complete Playwright testing suite that:
1. Loads the Map Gallery UI
2. Selects and renders maps from all formats
3. Takes screenshots and validates against baselines
4. Measures performance metrics (load time, FPS)
5. Runs in both local and CI environments
6. Generates visual diff reports on failures

### Success Criteria
- [ ] Playwright installed and configured for TypeScript
- [ ] WebGL/Babylon.js specific configuration applied
- [ ] Screenshot comparison baseline established for 3+ maps
- [ ] At least 5 e2e test scenarios implemented
- [ ] Docker configuration for CI environment
- [ ] GitHub Actions workflow configured
- [ ] Visual regression reports generated on failure
- [ ] All tests passing with <5% pixel difference tolerance
- [ ] Test execution time <3 minutes for full suite
- [ ] Integration with existing npm test scripts

---

## All Needed Context

### Documentation & References

```yaml
# MUST READ - Include these in your context window

- url: https://playwright.dev/docs/intro
  why: Official Playwright installation and configuration guide
  critical: TypeScript native support, screenshot API, parallel execution

- url: https://github.com/BarthPaleologue/BabylonPlaywrightExample
  why: Real-world Babylon.js + Playwright setup with WebGL screenshot testing
  critical: |
    - Minimal reproducible setup for WebGL/WebGPU testing
    - Screenshot comparison patterns
    - Docker configuration for CI environments
    - Test structure for visual regression

- url: https://github.com/BabylonJS/Babylon.js/blob/master/playwright.config.ts
  why: Official Babylon.js Playwright configuration
  critical: Separate test configs for WebGL2 and WebGPU

- url: https://forum.babylonjs.com/t/end-to-end-testing-with-playwright/58244
  why: Community tutorial on Playwright + Babylon.js integration
  critical: Best practices for WebGL testing, common pitfalls

- file: /Users/dcversus/conductor/edgecraft/.conductor/sydney/jest.config.js
  why: Existing test configuration patterns to mirror
  critical: Path aliases, module mappings, timeout settings (line 33-42)

- file: /Users/dcversus/conductor/edgecraft/.conductor/sydney/src/App.tsx
  why: Main application entry point and map loading flow
  critical: |
    - MapGallery component integration (lines 224-232)
    - Map loading handler (lines 158-201)
    - Canvas initialization (lines 67-127)
    - Error handling patterns

- file: /Users/dcversus/conductor/edgecraft/.conductor/sydney/src/engine/rendering/MapRendererCore.ts
  why: Core map rendering API to test
  critical: |
    - loadMap() method signature (returns MapRenderResult)
    - Loading/rendering time metrics
    - Error states to validate

- file: /Users/dcversus/conductor/edgecraft/.conductor/sydney/src/ui/MapGallery.tsx
  why: UI component selectors and interaction patterns
  critical: |
    - Map card selectors for clicking
    - Loading states to wait for
    - Error states to detect

- file: /Users/dcversus/conductor/edgecraft/.conductor/sydney/tests/ui/GameCanvas.test.tsx
  why: Existing UI test patterns to mirror
  critical: React Testing Library patterns, mocking strategies

- file: /Users/dcversus/conductor/edgecraft/.conductor/sydney/vite.config.ts
  why: Dev server configuration for test preview server
  critical: Port 3000 (line 67), HMR settings, proxy config

- file: /Users/dcversus/conductor/edgecraft/.conductor/sydney/package.json
  why: Existing test scripts and dependencies
  critical: |
    - Jest configuration (lines 18-20)
    - Test scripts naming convention
    - Node version requirement (line 115-117)
```

### Current Codebase Structure

```bash
edge-craft/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ App.tsx                          # Main app with MapGallery
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ MapGallery.tsx              # Map browsing UI
â”‚   â”‚   â””â”€â”€ __tests__/
â”‚   â”‚       â””â”€â”€ MapGallery.test.tsx     # Unit tests
â”‚   â”œâ”€â”€ engine/
â”‚   â”‚   â””â”€â”€ rendering/
â”‚   â”‚       â”œâ”€â”€ MapRendererCore.ts      # Core rendering API
â”‚   â”‚       â””â”€â”€ __tests__/
â”‚   â”‚           â””â”€â”€ MapRendererCore.test.ts
â”‚   â””â”€â”€ formats/
â”‚       â””â”€â”€ maps/
â”‚           â”œâ”€â”€ BatchMapLoader.ts       # Batch loading logic
â”‚           â””â”€â”€ types.ts                # RawMapData interface
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ setup.ts                        # Jest setup
â”‚   â”œâ”€â”€ engine/                         # Engine unit tests
â”‚   â”œâ”€â”€ formats/                        # Format parser tests
â”‚   â””â”€â”€ ui/                             # UI component tests
â”œâ”€â”€ maps/                               # 24 test maps
â”‚   â”œâ”€â”€ *.w3x                          # Warcraft 3 maps (14 files)
â”‚   â”œâ”€â”€ *.w3n                          # Campaigns (7 files)
â”‚   â””â”€â”€ *.SC2Map                       # StarCraft 2 (3 files)
â”œâ”€â”€ jest.config.js                     # Jest configuration
â”œâ”€â”€ vite.config.ts                     # Vite dev server
â””â”€â”€ package.json
```

### Desired Codebase Structure (After Implementation)

```bash
edge-craft/
â”œâ”€â”€ e2e/                                # NEW: Playwright tests
â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ map-gallery.spec.ts        # Gallery UI tests
â”‚   â”‚   â”œâ”€â”€ map-loading.spec.ts        # Map loading flow
â”‚   â”‚   â”œâ”€â”€ w3x-rendering.spec.ts      # W3X format rendering
â”‚   â”‚   â”œâ”€â”€ w3n-rendering.spec.ts      # W3N campaign rendering
â”‚   â”‚   â”œâ”€â”€ sc2-rendering.spec.ts      # SC2Map rendering
â”‚   â”‚   â””â”€â”€ visual-regression.spec.ts  # Screenshot comparisons
â”‚   â”œâ”€â”€ fixtures/
â”‚   â”‚   â”œâ”€â”€ test-maps.ts               # Test map metadata
â”‚   â”‚   â””â”€â”€ screenshot-helpers.ts      # Screenshot utilities
â”‚   â”œâ”€â”€ screenshots/                    # Baseline screenshots
â”‚   â”‚   â”œâ”€â”€ gallery-initial.png
â”‚   â”‚   â”œâ”€â”€ map-w3x-loaded.png
â”‚   â”‚   â”œâ”€â”€ map-w3n-loaded.png
â”‚   â”‚   â””â”€â”€ map-sc2-loaded.png
â”‚   â””â”€â”€ docker/
â”‚       â””â”€â”€ Dockerfile.playwright       # Docker config for CI
â”œâ”€â”€ playwright.config.ts                # Playwright config
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ e2e-tests.yml              # CI workflow
â””â”€â”€ package.json                        # Updated with playwright scripts
```

### Known Gotchas & Library Quirks

```typescript
// CRITICAL: WebGL Context Requirements
// Playwright needs GPU acceleration for WebGL rendering
// In CI: Use Docker with GPU support or swiftshader
// Local: Should work out of the box

// GOTCHA 1: Babylon.js async initialization
// MUST wait for scene.whenReadyAsync() before screenshots
await page.waitForFunction(() => {
  return window.engine && window.scene && window.scene.isReady();
});

// GOTCHA 2: Map loading is async with progress
// MUST wait for loading overlay to disappear
await page.waitForSelector('.loading-overlay', { state: 'hidden' });

// GOTCHA 3: Canvas screenshots need specific timing
// Wait for at least 2 frames to ensure rendering is complete
await page.waitForTimeout(100); // 2 frames at 60 FPS

// GOTCHA 4: WebGL contexts are limited
// Dispose scenes properly in afterEach() to avoid context loss
// Edge Craft already has proper disposal in MapRendererCore

// GOTCHA 5: Screenshot pixel differences
// Use threshold for anti-aliasing differences across systems
expect(await page.screenshot()).toMatchSnapshot({
  threshold: 0.05, // 5% difference allowed
});

// GOTCHA 6: File loading in Playwright
// Use page.setInputFiles() for file uploads
// Or fetch from /maps URL like App.tsx does

// GOTCHA 7: Vite dev server MUST be running
// Tests expect server on http://localhost:3000
// Use webServer config in playwright.config.ts

// GOTCHA 8: Path aliases in Playwright
// Playwright doesn't use tsconfig paths by default
// Use relative imports in e2e tests or configure playwright

// GOTCHA 9: CI environment differences
// macOS 13 has WebGL issues in WebKit, use macOS 14+
// Linux needs xvfb or docker with GPU support

// GOTCHA 10: Jest vs Playwright
// Different test syntax: describe/it (Jest) vs test.describe/test (Playwright)
// Different assertion libraries: expect (Jest) vs expect (Playwright)
```

---

## Implementation Blueprint

### Phase 1: Installation & Configuration (Task 1-3)

Install Playwright and configure for WebGL/Babylon.js testing with TypeScript support.

### Phase 2: Test Infrastructure (Task 4-6)

Create test fixtures, helpers, and baseline screenshots for comparison.

### Phase 3: Core Test Suites (Task 7-11)

Implement test scenarios covering gallery UI, map loading, and format-specific rendering.

### Phase 4: CI/CD Integration (Task 12-14)

Configure Docker and GitHub Actions for automated testing.

### Phase 5: Documentation & Validation (Task 15)

Document usage, update README, and validate full test suite.

---

## Implementation Tasks

### Task 1: Install Playwright and Dependencies

**Goal**: Install Playwright with TypeScript support and required browsers.

**Actions**:
```bash
# Install Playwright as dev dependency
npm install -D @playwright/test

# Install browsers (chromium, firefox, webkit)
npx playwright install --with-deps

# Verify installation
npx playwright --version
```

**Files Modified**:
- `package.json` - Add playwright to devDependencies

**Validation**:
```bash
# Should show Playwright version
npx playwright --version
```

---

### Task 2: Create Playwright Configuration

**Goal**: Configure Playwright for WebGL testing with proper timeouts, retries, and browser settings.

**CREATE** `playwright.config.ts`:

```typescript
import { defineConfig, devices } from '@playwright/test';

/**
 * Playwright Configuration for Edge Craft E2E Tests
 *
 * Specialized for WebGL/Babylon.js rendering tests with screenshot comparison.
 * Based on: https://github.com/BarthPaleologue/BabylonPlaywrightExample
 */
export default defineConfig({
  // Test directory
  testDir: './e2e/tests',

  // Baseline screenshots directory
  snapshotDir: './e2e/screenshots',

  // Timeout for each test (WebGL rendering can be slow)
  timeout: 60000, // 60 seconds

  // Expect timeout for assertions
  expect: {
    timeout: 10000,
    toMatchSnapshot: {
      // Allow 5% pixel difference for anti-aliasing variations
      threshold: 0.05,
      maxDiffPixels: 100,
    },
  },

  // Fail fast on CI, continue locally
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,

  // Parallel workers
  workers: process.env.CI ? 2 : undefined,

  // Reporter configuration
  reporter: [
    ['html', { outputFolder: 'playwright-report' }],
    ['list'],
    process.env.CI ? ['github'] : ['line'],
  ],

  // Shared settings for all tests
  use: {
    // Base URL for tests
    baseURL: 'http://localhost:3000',

    // Screenshot on failure for debugging
    screenshot: 'only-on-failure',

    // Video on failure
    video: 'retain-on-failure',

    // Trace on first retry
    trace: 'on-first-retry',

    // Viewport size (1920x1080 for consistent screenshots)
    viewport: { width: 1920, height: 1080 },

    // Action timeout
    actionTimeout: 15000,

    // Navigation timeout (map loading can be slow)
    navigationTimeout: 30000,
  },

  // Configure Vite dev server
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000, // 2 minutes to start
  },

  // Test projects for different browsers
  projects: [
    {
      name: 'chromium',
      use: {
        ...devices['Desktop Chrome'],
        // Enable WebGL
        launchOptions: {
          args: [
            '--enable-webgl',
            '--enable-gpu-rasterization',
            '--ignore-gpu-blocklist',
          ],
        },
      },
    },

    // Uncomment for cross-browser testing
    // {
    //   name: 'firefox',
    //   use: {
    //     ...devices['Desktop Firefox'],
    //     launchOptions: {
    //       firefoxUserPrefs: {
    //         'webgl.force-enabled': true,
    //       },
    //     },
    //   },
    // },

    // Note: WebKit/Safari has known WebGL issues on macOS 13
    // Use macOS 14+ for WebKit testing
    // {
    //   name: 'webkit',
    //   use: { ...devices['Desktop Safari'] },
    // },
  ],
});
```

**Validation**:
```bash
# Verify configuration is valid
npx playwright test --list
```

---

### Task 3: Add NPM Scripts

**Goal**: Add convenient npm scripts for running e2e tests.

**MODIFY** `package.json`:

```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:report": "playwright show-report",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:chromium": "playwright test --project=chromium",
    "test:e2e:update-snapshots": "playwright test --update-snapshots",
    "test:e2e:docker": "docker build -f e2e/docker/Dockerfile.playwright -t edgecraft-e2e . && docker run --rm edgecraft-e2e",
    "test:all": "npm run test && npm run test:e2e"
  }
}
```

**Validation**:
```bash
npm run test:e2e -- --help
```

---

### Task 4: Create Test Fixtures and Helpers

**Goal**: Create reusable test utilities for map loading and screenshot comparison.

**CREATE** `e2e/fixtures/test-maps.ts`:

```typescript
/**
 * Test Map Metadata
 *
 * Subset of production maps for e2e testing.
 * Selected to cover all formats and size ranges.
 */
export const TEST_MAPS = {
  // Small W3X map (fast loading for smoke tests)
  W3X_SMALL: {
    name: 'Footmen Frenzy 1.9f.w3x',
    format: 'w3x',
    expectedLoadTime: 5000, // ms
    expectedFPS: 60,
  },

  // Medium W3X map (typical size)
  W3X_MEDIUM: {
    name: '3P Sentinel 01 v3.06.w3x',
    format: 'w3x',
    expectedLoadTime: 8000,
    expectedFPS: 60,
  },

  // W3N campaign (large file with multiple maps)
  W3N_CAMPAIGN: {
    name: 'SearchingForPower.w3n',
    format: 'w3n',
    expectedLoadTime: 15000,
    expectedFPS: 55, // Lower FPS expected for campaigns
  },

  // SC2Map (different format)
  SC2_MAP: {
    name: 'Ruined Citadel.SC2Map',
    format: 'sc2map',
    expectedLoadTime: 5000,
    expectedFPS: 60,
  },
} as const;

export type TestMapKey = keyof typeof TEST_MAPS;
```

**CREATE** `e2e/fixtures/screenshot-helpers.ts`:

```typescript
import { Page, expect } from '@playwright/test';

/**
 * Screenshot Helper Utilities
 */

/**
 * Wait for Babylon.js scene to be ready
 */
export async function waitForSceneReady(page: Page): Promise<void> {
  // Wait for engine and scene to be initialized
  await page.waitForFunction(() => {
    const canvas = document.querySelector('canvas.babylon-canvas');
    return canvas !== null;
  }, { timeout: 10000 });

  // Wait for scene render loop to start (at least 2 frames)
  await page.waitForTimeout(100);
}

/**
 * Wait for map loading to complete
 */
export async function waitForMapLoaded(page: Page): Promise<void> {
  // Wait for loading overlay to disappear
  await page.waitForSelector('.loading-overlay', {
    state: 'hidden',
    timeout: 30000, // Maps can take time to load
  });

  // Wait for error overlay NOT to appear
  const errorOverlay = page.locator('.error-overlay');
  await expect(errorOverlay).toBeHidden();

  // Extra wait for rendering to stabilize
  await page.waitForTimeout(500);
}

/**
 * Take canvas screenshot
 */
export async function screenshotCanvas(page: Page, name: string): Promise<Buffer> {
  const canvas = page.locator('canvas.babylon-canvas');
  await expect(canvas).toBeVisible();

  return await canvas.screenshot({
    type: 'png',
  });
}

/**
 * Get FPS from UI
 */
export async function getFPS(page: Page): Promise<number> {
  const fpsText = await page.locator('.header-stats .stat').first().textContent();
  const match = fpsText?.match(/FPS: (\d+)/);
  return match ? parseInt(match[1]) : 0;
}

/**
 * Select map from gallery
 */
export async function selectMap(page: Page, mapName: string): Promise<void> {
  // Find map card by name
  const mapCard = page.locator(`[aria-label="Load map: ${mapName}"]`);
  await expect(mapCard).toBeVisible();

  // Click to load
  await mapCard.click();

  // Wait for gallery to hide
  await page.waitForSelector('.gallery-view', { state: 'hidden' });
}
```

**Validation**:
```bash
# TypeScript should compile without errors
npx tsc --noEmit
```

---

### Task 5: Create Baseline Screenshots Directory

**Goal**: Set up directory structure for screenshot baselines.

**Actions**:
```bash
mkdir -p e2e/screenshots
touch e2e/screenshots/.gitkeep
```

**CREATE** `e2e/screenshots/README.md`:

```markdown
# E2E Screenshot Baselines

This directory contains baseline screenshots for visual regression testing.

## Structure

- `gallery-initial.png` - Initial map gallery view
- `map-{format}-loaded.png` - Map rendered in viewer
- `*-diff.png` - Generated diff images on failure (gitignored)

## Updating Baselines

When visual changes are intentional, update baselines:

\`\`\`bash
npm run test:e2e:update-snapshots
\`\`\`

## CI Behavior

- CI runs with 5% pixel difference tolerance
- Diffs are uploaded as artifacts on failure
- Screenshots are compared across Chromium only (consistent rendering)
```

**UPDATE** `.gitignore`:

```
# Playwright
/playwright-report/
/test-results/
/playwright/.cache/
/e2e/screenshots/*-diff.png
/e2e/screenshots/*-actual.png
```

---

### Task 6: Create Docker Configuration for CI

**Goal**: Enable consistent e2e tests in CI environment with GPU support.

**CREATE** `e2e/docker/Dockerfile.playwright`:

```dockerfile
# Based on: https://github.com/BarthPaleologue/BabylonPlaywrightExample
FROM mcr.microsoft.com/playwright:v1.48.0-jammy

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci

# Copy source code
COPY . .

# Run Playwright tests
CMD ["npx", "playwright", "test"]
```

**CREATE** `e2e/docker/docker-compose.yml`:

```yaml
version: '3.8'

services:
  e2e-tests:
    build:
      context: ../..
      dockerfile: e2e/docker/Dockerfile.playwright
    volumes:
      - ../../playwright-report:/app/playwright-report
      - ../../test-results:/app/test-results
    environment:
      - CI=true
      - NODE_ENV=test
```

**Validation**:
```bash
# Build docker image
docker build -f e2e/docker/Dockerfile.playwright -t edgecraft-e2e .

# Should build successfully
```

---

### Task 7: Test Map Gallery UI

**Goal**: Test gallery rendering, search, filters, and sorting.

**CREATE** `e2e/tests/map-gallery.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('Map Gallery', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
    // Wait for maps to load
    await page.waitForSelector('.gallery-view');
  });

  test('should display map gallery with all maps', async ({ page }) => {
    // Verify title
    await expect(page.locator('h1')).toContainText('Edge Craft');

    // Verify gallery is visible
    const gallery = page.locator('.gallery-view');
    await expect(gallery).toBeVisible();

    // Verify map count (24 maps total)
    const mapCount = page.locator('.map-gallery h3');
    await expect(mapCount).toContainText('24 maps');
  });

  test('should filter maps by search query', async ({ page }) => {
    // Type in search box
    const searchInput = page.locator('input[placeholder="Search maps..."]');
    await searchInput.fill('Sentinel');

    // Verify filtered results
    await expect(page.locator('.map-card')).toHaveCount(7); // 7 Sentinel maps
  });

  test('should filter maps by format', async ({ page }) => {
    // Select W3N format filter
    const formatFilter = page.locator('select[aria-label="Filter by format"]');
    await formatFilter.selectOption('w3n');

    // Verify only W3N maps shown
    const maps = page.locator('.map-card');
    const count = await maps.count();
    expect(count).toBe(7); // 7 W3N campaign files
  });

  test('should sort maps by size', async ({ page }) => {
    // Select size sort
    const sortSelect = page.locator('select[aria-label="Sort by"]');
    await sortSelect.selectOption('size');

    // Get first and last map sizes
    const firstSize = await page.locator('.map-card .map-size').first().textContent();
    const lastSize = await page.locator('.map-card .map-size').last().textContent();

    // First should be smaller than last (ascending order)
    const firstMB = parseFloat(firstSize?.replace(' MB', '') || '0');
    const lastMB = parseFloat(lastSize?.replace(' MB', '') || '0');
    expect(firstMB).toBeLessThan(lastMB);
  });

  test('should take baseline screenshot of gallery', async ({ page }) => {
    // Wait for all map cards to render
    await page.waitForSelector('.map-card', { timeout: 5000 });

    // Take screenshot for baseline
    await expect(page).toHaveScreenshot('gallery-initial.png', {
      fullPage: true,
    });
  });

  test('should navigate to viewer on map selection', async ({ page }) => {
    // Click first map card
    const firstMap = page.locator('.map-card').first();
    await firstMap.click();

    // Verify gallery is hidden
    await expect(page.locator('.gallery-view')).toBeHidden();

    // Verify viewer is visible
    await expect(page.locator('.viewer-view')).toBeVisible();
  });
});
```

---

### Task 8: Test W3X Map Loading and Rendering

**Goal**: Test Warcraft 3 map format loading with screenshot validation.

**CREATE** `e2e/tests/w3x-rendering.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { TEST_MAPS } from '../fixtures/test-maps';
import { waitForMapLoaded, screenshotCanvas, getFPS, selectMap } from '../fixtures/screenshot-helpers';

test.describe('W3X Map Rendering', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
    await page.waitForSelector('.gallery-view');
  });

  test('should load small W3X map successfully', async ({ page }) => {
    const mapData = TEST_MAPS.W3X_SMALL;

    // Measure load time
    const startTime = Date.now();

    // Select map
    await selectMap(page, mapData.name);

    // Wait for map to load
    await waitForMapLoaded(page);

    const loadTime = Date.now() - startTime;

    // Verify load time is within expected range
    expect(loadTime).toBeLessThan(mapData.expectedLoadTime);

    // Verify canvas is visible
    const canvas = page.locator('canvas.babylon-canvas');
    await expect(canvas).toBeVisible();

    // Verify no error overlay
    await expect(page.locator('.error-overlay')).toBeHidden();
  });

  test('should render W3X map correctly (screenshot)', async ({ page }) => {
    const mapData = TEST_MAPS.W3X_MEDIUM;

    // Load map
    await selectMap(page, mapData.name);
    await waitForMapLoaded(page);

    // Take screenshot
    const canvas = page.locator('canvas.babylon-canvas');
    await expect(canvas).toHaveScreenshot('map-w3x-loaded.png', {
      threshold: 0.05,
    });
  });

  test('should maintain target FPS while rendering', async ({ page }) => {
    const mapData = TEST_MAPS.W3X_SMALL;

    // Load map
    await selectMap(page, mapData.name);
    await waitForMapLoaded(page);

    // Wait for FPS to stabilize
    await page.waitForTimeout(2000);

    // Check FPS multiple times
    const fpsReadings: number[] = [];
    for (let i = 0; i < 5; i++) {
      const fps = await getFPS(page);
      fpsReadings.push(fps);
      await page.waitForTimeout(500);
    }

    // Average FPS should be close to target
    const avgFPS = fpsReadings.reduce((a, b) => a + b, 0) / fpsReadings.length;
    expect(avgFPS).toBeGreaterThan(mapData.expectedFPS * 0.9); // Allow 10% variance
  });

  test('should display map metadata in header', async ({ page }) => {
    const mapData = TEST_MAPS.W3X_MEDIUM;

    // Load map
    await selectMap(page, mapData.name);
    await waitForMapLoaded(page);

    // Verify current map name is shown
    const currentMapInfo = page.locator('.current-map-info strong');
    await expect(currentMapInfo).toContainText(mapData.name);

    // Verify format badge
    const formatBadge = page.locator('.map-format');
    await expect(formatBadge).toContainText('W3X');
  });

  test('should navigate back to gallery', async ({ page }) => {
    const mapData = TEST_MAPS.W3X_SMALL;

    // Load map
    await selectMap(page, mapData.name);
    await waitForMapLoaded(page);

    // Click back button
    await page.locator('button.btn-back').click();

    // Verify gallery is visible again
    await expect(page.locator('.gallery-view')).toBeVisible();
    await expect(page.locator('.viewer-view')).toBeHidden();
  });
});
```

---

### Task 9: Test W3N Campaign Loading

**Goal**: Test Warcraft 3 campaign format with multiple maps.

**CREATE** `e2e/tests/w3n-rendering.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { TEST_MAPS } from '../fixtures/test-maps';
import { waitForMapLoaded, screenshotCanvas, selectMap } from '../fixtures/screenshot-helpers';

test.describe('W3N Campaign Rendering', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
    await page.waitForSelector('.gallery-view');
  });

  test('should load W3N campaign successfully', async ({ page }) => {
    const mapData = TEST_MAPS.W3N_CAMPAIGN;

    // Campaign files are larger, expect longer load
    test.setTimeout(mapData.expectedLoadTime + 10000);

    // Select campaign
    await selectMap(page, mapData.name);

    // Wait for loading to complete (campaigns take longer)
    await waitForMapLoaded(page);

    // Verify canvas is visible
    const canvas = page.locator('canvas.babylon-canvas');
    await expect(canvas).toBeVisible();
  });

  test('should render W3N campaign correctly (screenshot)', async ({ page }) => {
    const mapData = TEST_MAPS.W3N_CAMPAIGN;
    test.setTimeout(mapData.expectedLoadTime + 10000);

    // Load campaign
    await selectMap(page, mapData.name);
    await waitForMapLoaded(page);

    // Take screenshot
    const canvas = page.locator('canvas.babylon-canvas');
    await expect(canvas).toHaveScreenshot('map-w3n-loaded.png', {
      threshold: 0.05,
    });
  });

  test('should handle large campaign files without timeout', async ({ page }) => {
    const mapData = TEST_MAPS.W3N_CAMPAIGN;
    test.setTimeout(mapData.expectedLoadTime + 10000);

    // Select large campaign
    await selectMap(page, mapData.name);

    // Should NOT show error
    await waitForMapLoaded(page);
    await expect(page.locator('.error-overlay')).toBeHidden();
  });
});
```

---

### Task 10: Test SC2Map Loading

**Goal**: Test StarCraft 2 map format rendering.

**CREATE** `e2e/tests/sc2-rendering.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { TEST_MAPS } from '../fixtures/test-maps';
import { waitForMapLoaded, screenshotCanvas, selectMap } from '../fixtures/screenshot-helpers';

test.describe('SC2Map Rendering', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
    await page.waitForSelector('.gallery-view');
  });

  test('should load SC2Map successfully', async ({ page }) => {
    const mapData = TEST_MAPS.SC2_MAP;

    // Select SC2 map
    await selectMap(page, mapData.name);

    // Wait for loading
    await waitForMapLoaded(page);

    // Verify canvas rendering
    const canvas = page.locator('canvas.babylon-canvas');
    await expect(canvas).toBeVisible();
  });

  test('should render SC2Map correctly (screenshot)', async ({ page }) => {
    const mapData = TEST_MAPS.SC2_MAP;

    // Load map
    await selectMap(page, mapData.name);
    await waitForMapLoaded(page);

    // Take screenshot
    const canvas = page.locator('canvas.babylon-canvas');
    await expect(canvas).toHaveScreenshot('map-sc2-loaded.png', {
      threshold: 0.05,
    });
  });

  test('should display correct format badge for SC2Map', async ({ page }) => {
    const mapData = TEST_MAPS.SC2_MAP;

    // Load map
    await selectMap(page, mapData.name);
    await waitForMapLoaded(page);

    // Verify SC2 format badge
    const formatBadge = page.locator('.map-format');
    await expect(formatBadge).toContainText('SC2MAP');
  });
});
```

---

### Task 11: Test Visual Regression Suite

**Goal**: Comprehensive visual regression tests for critical UI states.

**CREATE** `e2e/tests/visual-regression.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { TEST_MAPS } from '../fixtures/test-maps';
import { waitForMapLoaded, selectMap } from '../fixtures/screenshot-helpers';

test.describe('Visual Regression Tests', () => {
  test('homepage - initial load', async ({ page }) => {
    await page.goto('/');
    await page.waitForSelector('.gallery-view');

    await expect(page).toHaveScreenshot('homepage.png', {
      fullPage: true,
      threshold: 0.05,
    });
  });

  test('map gallery - search results', async ({ page }) => {
    await page.goto('/');

    // Search for "Sentinel"
    const searchInput = page.locator('input[placeholder="Search maps..."]');
    await searchInput.fill('Sentinel');
    await page.waitForTimeout(300); // Debounce

    await expect(page).toHaveScreenshot('gallery-search-sentinel.png', {
      fullPage: true,
      threshold: 0.05,
    });
  });

  test('map viewer - loading state', async ({ page }) => {
    await page.goto('/');

    // Click map to trigger loading
    const mapCard = page.locator('.map-card').first();
    await mapCard.click();

    // Capture loading overlay
    const loadingOverlay = page.locator('.loading-overlay');
    await expect(loadingOverlay).toBeVisible();

    await expect(page).toHaveScreenshot('viewer-loading.png', {
      threshold: 0.05,
    });
  });

  test('map viewer - error state', async ({ page }) => {
    await page.goto('/');

    // Simulate error by loading non-existent map
    // (We'd need to mock this or trigger error state)
    // For now, just verify error overlay structure exists
    const errorOverlay = page.locator('.error-overlay');
    // Should be hidden initially
    await expect(errorOverlay).toBeHidden();
  });

  test('map viewer - back button UI', async ({ page }) => {
    await page.goto('/');

    // Load a map
    await selectMap(page, TEST_MAPS.W3X_SMALL.name);
    await waitForMapLoaded(page);

    // Verify back button is visible
    await expect(page.locator('button.btn-back')).toBeVisible();

    await expect(page).toHaveScreenshot('viewer-controls.png', {
      clip: { x: 0, y: 0, width: 1920, height: 200 }, // Just header area
      threshold: 0.05,
    });
  });
});
```

---

### Task 12: Create GitHub Actions Workflow

**Goal**: Automate e2e tests in CI with screenshot upload on failure.

**CREATE** `.github/workflows/e2e-tests.yml`:

```yaml
name: E2E Tests (Playwright)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true

      - name: Upload Playwright Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload Test Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 7

      - name: Comment PR with Test Results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ E2E tests failed. View the [Playwright report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
```

---

### Task 13: Update GitHub Actions Matrix

**Goal**: Integrate e2e tests into existing CI pipeline.

**MODIFY** `.github/workflows/gate-2-implementation.yml`:

Add e2e tests to the existing test job:

```yaml
  # ... existing jobs ...

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [typecheck, unit-tests]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - run: npm run test:e2e
        env:
          CI: true
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
```

---

### Task 14: Document E2E Testing

**Goal**: Provide clear documentation for running and maintaining e2e tests.

**CREATE** `e2e/README.md`:

```markdown
# Edge Craft E2E Testing

End-to-end testing infrastructure using Playwright for WebGL/Babylon.js rendering validation.

## Quick Start

### Run All E2E Tests
\`\`\`bash
npm run test:e2e
\`\`\`

### Run Tests in UI Mode (Interactive)
\`\`\`bash
npm run test:e2e:ui
\`\`\`

### Debug Tests
\`\`\`bash
npm run test:e2e:debug
\`\`\`

### Update Screenshot Baselines
\`\`\`bash
npm run test:e2e:update-snapshots
\`\`\`

## Test Structure

- `tests/map-gallery.spec.ts` - Gallery UI, search, filters
- `tests/w3x-rendering.spec.ts` - W3X map loading/rendering
- `tests/w3n-rendering.spec.ts` - W3N campaign loading
- `tests/sc2-rendering.spec.ts` - SC2Map loading
- `tests/visual-regression.spec.ts` - Screenshot comparisons

## Writing New Tests

### Basic Test Pattern

\`\`\`typescript
import { test, expect } from '@playwright/test';

test('my new test', async ({ page }) => {
  await page.goto('/');
  // ... test actions
});
\`\`\`

### Using Helpers

\`\`\`typescript
import { selectMap, waitForMapLoaded } from '../fixtures/screenshot-helpers';

test('test map loading', async ({ page }) => {
  await page.goto('/');
  await selectMap(page, 'Footmen Frenzy 1.9f.w3x');
  await waitForMapLoaded(page);
  // ... assertions
});
\`\`\`

## CI Integration

E2E tests run automatically on:
- Push to `main` or `develop`
- Pull requests to `main` or `develop`

Failed test artifacts (screenshots, videos, traces) are uploaded for debugging.

## Docker Testing

Run tests in Docker for CI consistency:

\`\`\`bash
npm run test:e2e:docker
\`\`\`

## Troubleshooting

### Tests Timeout
- Increase timeout in `playwright.config.ts`
- Check dev server is starting correctly

### Screenshot Differences
- Anti-aliasing can vary across systems
- Update baselines if changes are intentional
- Use 5% threshold for tolerance

### WebGL Context Loss
- Ensure proper scene disposal in tests
- Check browser GPU support

## Resources

- [Playwright Docs](https://playwright.dev/docs/intro)
- [Babylon.js Playwright Example](https://github.com/BarthPaleologue/BabylonPlaywrightExample)
- [Edge Craft Testing Guide](../CONTRIBUTING.md#testing)
```

**UPDATE** `README.md` (add to Development section):

```markdown
## ðŸ§ª Testing

Edge Craft has comprehensive test coverage:

### Unit Tests (Jest)
\`\`\`bash
npm test                 # Run all unit tests
npm run test:watch       # Watch mode
npm run test:coverage    # Coverage report
\`\`\`

### E2E Tests (Playwright)
\`\`\`bash
npm run test:e2e         # Run all e2e tests
npm run test:e2e:ui      # Interactive UI mode
npm run test:e2e:debug   # Debug mode with browser
\`\`\`

### All Tests
\`\`\`bash
npm run test:all         # Run unit + e2e tests
\`\`\`
```

---

### Task 15: Final Validation & Cleanup

**Goal**: Ensure all tests pass and infrastructure is production-ready.

**Actions**:

1. Run full test suite:
```bash
# Install dependencies
npm ci
npx playwright install --with-deps

# Run e2e tests
npm run test:e2e

# Generate baseline screenshots
npm run test:e2e:update-snapshots

# Verify screenshots committed
git add e2e/screenshots/*.png
git status
```

2. Validate TypeScript compilation:
```bash
npx tsc --noEmit
```

3. Verify CI workflow syntax:
```bash
# GitHub Actions syntax check
gh workflow view e2e-tests
```

4. Test Docker build:
```bash
docker build -f e2e/docker/Dockerfile.playwright -t edgecraft-e2e .
docker run --rm edgecraft-e2e
```

5. Update CLAUDE.md with new test commands:
```markdown
## Testing
- npm test            # Unit tests (Jest)
- npm run test:e2e    # E2E tests (Playwright)
- npm run test:all    # All tests
```

---

## Validation Loop

### Level 1: Installation & Configuration

```bash
# Verify Playwright installed
npx playwright --version
# Expected: Version 1.48.0 or later

# Verify browsers installed
npx playwright install --dry-run
# Expected: chromium, firefox, webkit listed

# Verify configuration valid
npx playwright test --list
# Expected: List of 20+ tests across 6 test files
```

### Level 2: Test Execution

```bash
# Run smoke test (fastest)
npx playwright test tests/map-gallery.spec.ts

# Expected: All tests pass (green)
# If failures: Check dev server running on :3000

# Run format-specific tests
npx playwright test tests/w3x-rendering.spec.ts
npx playwright test tests/w3n-rendering.spec.ts
npx playwright test tests/sc2-rendering.spec.ts

# Expected: All tests pass with screenshot comparisons
```

### Level 3: Visual Regression

```bash
# Update baselines
npm run test:e2e:update-snapshots

# Run visual regression suite
npx playwright test tests/visual-regression.spec.ts

# Expected: All screenshots match within 5% threshold
# If failures: Review diff images in test-results/
```

### Level 4: CI Integration

```bash
# Test Docker build
docker build -f e2e/docker/Dockerfile.playwright -t edgecraft-e2e .
docker run --rm edgecraft-e2e

# Expected: Tests run in container, results output

# Validate GitHub Actions syntax
gh workflow view e2e-tests

# Expected: Workflow valid, no syntax errors
```

---

## Final Validation Checklist

- [ ] `npx playwright --version` shows 1.48.0+
- [ ] `npx playwright test --list` shows 20+ tests
- [ ] `npm run test:e2e` passes all tests (<3 minutes)
- [ ] Screenshot baselines committed to `e2e/screenshots/`
- [ ] Visual diffs within 5% threshold
- [ ] Docker build succeeds
- [ ] GitHub Actions workflow valid
- [ ] README.md updated with e2e commands
- [ ] CLAUDE.md updated with test commands
- [ ] All TypeScript compiles: `npx tsc --noEmit`

---

## Anti-Patterns to Avoid

- âŒ Don't commit screenshot diffs (`*-diff.png`, `*-actual.png`)
- âŒ Don't use `page.waitForTimeout()` excessively (use `waitForSelector()`)
- âŒ Don't hardcode timeouts (use config values)
- âŒ Don't skip baseline screenshot updates when visual changes are intentional
- âŒ Don't run all browsers locally (use Chromium only, CI tests others)
- âŒ Don't ignore flaky tests (fix root cause or increase wait times)
- âŒ Don't test implementation details (test user-visible behavior)
- âŒ Don't duplicate unit test coverage (e2e tests integration only)

---

## PRP Self-Assessment Score

**Confidence Level: 9/10**

**Strengths**:
- âœ… Complete context from codebase (App.tsx, MapRendererCore, MapGallery)
- âœ… Real-world examples from Babylon.js official repo
- âœ… Clear task breakdown with validation steps
- âœ… Docker and CI configuration included
- âœ… Comprehensive test scenarios covering all formats
- âœ… Helper utilities for reusable test logic
- âœ… Clear documentation and troubleshooting guide

**Potential Gaps**:
- âš ï¸ May need adjustment to screenshot thresholds after first run
- âš ï¸ Docker GPU support might need tweaking for specific CI environments
- âš ï¸ Visual regression baseline generation requires manual review first time

**Mitigation**:
- Initial test run will generate baselines for review
- CI environment can adjust GPU flags as needed
- Clear documentation guides baseline updates

**Expected Outcome**: One-pass implementation with minor baseline adjustments after first test run.
