# PRP 1.5: Map Loading Architecture

**Status**: ðŸ“‹ Ready to Implement | **Effort**: 8 days | **Lines**: ~1,900  
**Dependencies**: PRP 1.1 (Engine), PRP 1.2 (Terrain), formats/mpq/MPQParser.ts

---

## Goal

Implement a complete map loading pipeline supporting W3X/W3M (Warcraft 3) and SCM/SCX (StarCraft 1) formats with 95% compatibility and conversion to legal .edgestory format.

---

## Why

**DoD Requirements**:
- 95% W3X/W3M map compatibility
- 95% SCM/SCX map compatibility  
- <10s load time for W3X, <5s for SCM
- 98% terrain conversion accuracy
- Automatic asset replacement (legal compliance)

---

## What

Complete map loading system with:

1. **W3X/W3M Parser** - war3map.w3i, w3e, doo, units files
2. **SCM/SCX Parser** - CHK format with all chunk types
3. **.edgestory Converter** - Legal format with asset replacement
4. **Asset Mapper** - Copyrighted â†’ legal asset mapping
5. **Map Validator** - 98% accuracy validation

---

## Implementation

### Architecture

```
src/formats/maps/
â”œâ”€â”€ MapLoaderRegistry.ts          # Main entry point (200 lines)
â”œâ”€â”€ w3x/
â”‚   â”œâ”€â”€ W3XMapLoader.ts           # W3X parser (300 lines)
â”‚   â”œâ”€â”€ W3IParser.ts              # Map info (150 lines)
â”‚   â”œâ”€â”€ W3EParser.ts              # Terrain (200 lines)
â”‚   â”œâ”€â”€ W3DParser.ts              # Doodads (150 lines)
â”‚   â””â”€â”€ W3UParser.ts              # Units (150 lines)
â”œâ”€â”€ scm/
â”‚   â”œâ”€â”€ SCMMapLoader.ts           # SCM parser (250 lines)
â”‚   â””â”€â”€ CHKParser.ts              # CHK chunks (200 lines)
â”œâ”€â”€ edgestory/
â”‚   â”œâ”€â”€ EdgeStoryConverter.ts     # Converter (300 lines)
â”‚   â””â”€â”€ EdgeStoryFormat.ts        # Format spec (150 lines)
â””â”€â”€ AssetMapper.ts                # Asset replacement (150 lines)
```

### Core Implementation

```typescript
// src/formats/maps/MapLoaderRegistry.ts
export class MapLoaderRegistry {
  private loaders = new Map<string, IMapLoader>();

  constructor() {
    this.loaders.set('.w3x', new W3XMapLoader());
    this.loaders.set('.w3m', new W3MMapLoader());
    this.loaders.set('.scm', new SCMMapLoader());
    this.loaders.set('.scx', new SCXMapLoader());
  }

  async loadMap(file: File): Promise<EdgeStoryMap> {
    const ext = this.getExtension(file.name);
    const loader = this.loaders.get(ext);
    
    // 1. Parse map
    const rawMap = await loader.parse(file);
    
    // 2. Convert to .edgestory
    const converter = new EdgeStoryConverter();
    const edgeMap = await converter.convert(rawMap);
    
    // 3. Replace copyrighted assets
    const mapper = new AssetMapper();
    await mapper.replaceAssets(edgeMap);
    
    return edgeMap;
  }
}

// .edgestory Format
export interface EdgeStoryMap {
  version: string;
  metadata: {
    title: string;
    author: string;
    originalFormat: 'w3x' | 'scm';
    license: 'CC0' | 'MIT';
  };
  terrain: {
    heightmap: ArrayBuffer;
    splatmap: ArrayBuffer;
    textures: string[];
    width: number;
    height: number;
  };
  units: UnitPlacement[];
  triggers: TriggerData[];
  assets: AssetManifest;
}
```

---

## Success Criteria

- [ ] 95% W3X maps load correctly (test with 100 maps)
- [ ] 95% SCM maps load correctly (test with 50 maps)
- [ ] <10s W3X load time, <5s SCM load time
- [ ] 98% terrain conversion accuracy
- [ ] 100% asset replacement (no copyrighted assets)
- [ ] All map metadata preserved

---

## Testing

```bash
# Map compatibility
npm run test:maps -- --format w3x --count 100  # 95% pass rate
npm run test:maps -- --format scm --count 50   # 95% pass rate

# Performance
npm run benchmark -- map-loading  # <10s W3X, <5s SCM

# Asset validation
npm run test:asset-replacement  # 100% legal assets
```

---

## Rollout (8 days)

- **Days 1-3**: W3X parser (w3i, w3e, doo, units)
- **Days 4-5**: SCM parser (CHK format)
- **Days 6-7**: .edgestory converter + asset mapper
- **Day 8**: Testing + optimization

---

See FORMATS_RESEARCH.md for complete specifications.
