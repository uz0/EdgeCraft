# PRP 1.7: Automated Legal Compliance Pipeline

**Status**: 📋 Ready to Implement | **Effort**: 3 days | **Lines**: ~650  
**Dependencies**: CopyrightValidator.ts (existing)

---

## Goal

Implement automated CI/CD pipeline for copyright validation, asset replacement, and license attribution to ensure zero copyrighted assets in production builds.

---

## Why

**DoD Requirements**:
- Zero copyrighted assets in production
- 100% detection of copyrighted content
- Automated asset replacement with legal alternatives
- Complete license attribution

---

## What

Complete legal compliance automation:

1. **CI/CD Integration** - GitHub Actions validation
2. **Asset Database** - 100+ copyrighted → legal mappings
3. **Visual Similarity** - Perceptual hashing detection
4. **Automated Attribution** - License file generation
5. **Pre-commit Hooks** - Block violations before commit

---

## Implementation

### Architecture

```
src/assets/validation/
├── CompliancePipeline.ts         # Main pipeline (300 lines)
├── AssetDatabase.ts              # Mapping database (150 lines)
├── VisualSimilarity.ts           # Perceptual hash (100 lines)
└── LicenseGenerator.ts           # Attribution (100 lines)

.github/workflows/
└── validate-assets.yml           # CI/CD workflow

scripts/
└── pre-commit-hook.sh            # Git pre-commit
```

### Core Implementation

```typescript
// src/assets/validation/CompliancePipeline.ts
export class LegalCompliancePipeline {
  private validator: CopyrightValidator;
  private assetDB: AssetDatabase;
  
  async validateAndReplace(
    asset: ArrayBuffer,
    metadata: AssetMetadata
  ): Promise<ValidatedAsset> {
    // 1. SHA-256 hash check
    const hash = await this.computeHash(asset);
    
    if (this.isBlacklisted(hash)) {
      console.warn(`Rejected: ${metadata.name}`);
      return await this.findReplacement(metadata);
    }
    
    // 2. Embedded metadata check
    const embedded = await this.extractMetadata(asset);
    if (this.containsCopyright(embedded)) {
      return await this.findReplacement(metadata);
    }
    
    // 3. Visual similarity (textures/models)
    if (['texture', 'model'].includes(metadata.type)) {
      const similarity = await this.checkVisualSimilarity(asset, metadata);
      if (similarity > 0.95) {
        return await this.findReplacement(metadata);
      }
    }
    
    return { asset, metadata, validated: true };
  }
  
  async findReplacement(metadata: AssetMetadata): Promise<ValidatedAsset> {
    const replacement = await this.assetDB.findReplacement({
      type: metadata.type,
      category: metadata.category,
      tags: metadata.tags
    });
    
    if (!replacement) {
      throw new Error(`No legal replacement: ${metadata.name}`);
    }
    
    return {
      asset: replacement.buffer,
      metadata: {
        ...replacement.metadata,
        originalName: metadata.name,
        replacedDueToCopyright: true
      },
      validated: true
    };
  }
}

// Asset replacement database
export interface AssetMapping {
  original: {
    hash: string;
    name: string;
    game: 'wc3' | 'sc1' | 'sc2';
  };
  replacement: {
    path: string;
    license: 'CC0' | 'MIT';
    source: string;
    visualSimilarity: number;
  };
}
```

### CI/CD Workflow

```yaml
# .github/workflows/validate-assets.yml
name: Asset Copyright Validation

on: [push, pull_request]

jobs:
  copyright-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate Assets
        run: npm run test:copyright
      
      - name: Check for Violations
        run: |
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo "❌ Copyright violations detected"
            exit 1
          fi
      
      - name: Generate Attribution
        run: npm run generate:attribution
      
      - name: Upload Attribution File
        uses: actions/upload-artifact@v3
        with:
          name: LICENSES.md
          path: assets/LICENSES.md
```

### Pre-commit Hook

```bash
#!/bin/bash
# scripts/pre-commit-hook.sh

echo "🔍 Checking for copyrighted assets..."

# Run copyright validation
npm run test:copyright --silent

if [ $? -ne 0 ]; then
  echo "❌ Copyright violations detected!"
  echo "Please remove or replace copyrighted assets"
  exit 1
fi

echo "✅ All assets validated"
exit 0
```

---

## Asset Database Schema

```typescript
// Initial database with 100+ mappings
const ASSET_MAPPINGS: AssetMapping[] = [
  {
    original: {
      hash: 'abc123...',
      name: 'Footman',
      game: 'wc3'
    },
    replacement: {
      path: 'assets/units/edge_footman.gltf',
      license: 'CC0',
      source: 'https://sketchfab.com/...',
      visualSimilarity: 0.65
    }
  },
  // ... 100+ more mappings
];
```

---

## Success Criteria

- [ ] 100% detection of test copyrighted assets
- [ ] CI/CD pipeline blocks violating merges
- [ ] Asset database covers 100+ unit types
- [ ] Visual similarity detection >90% accurate
- [ ] License attribution file auto-generated
- [ ] Pre-commit hook prevents violations
- [ ] Zero false positives in validation

---

## Testing

```bash
# Copyright detection
npm run test:copyright
# Expected: 100% detection rate

# Asset replacement
npm run test:asset-replacement
# Expected: All copyrighted → legal

# CI/CD simulation
npm run test:ci-validation
# Expected: Blocks violations, passes clean assets
```

---

## Rollout (3 days)

- **Day 1**: Extend CopyrightValidator with visual similarity
- **Day 2**: Asset database + replacement system
- **Day 3**: CI/CD integration + pre-commit hooks

---

## Key Features

- SHA-256 hash blacklist (known copyrighted assets)
- Metadata scanning (embedded copyright notices)
- Visual similarity (perceptual hashing for images)
- Automated replacement (100+ mappings)
- CI/CD enforcement (block violating PRs)
- License attribution (auto-generated LICENSES.md)
