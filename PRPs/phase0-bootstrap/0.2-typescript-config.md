name: "PRP 0.2: TypeScript Configuration"
phase: 0
parallel: true
description: |
  Configure TypeScript with strict mode, path aliases, and optimal settings for Edge Craft development.

## 📋 Definition of Ready (DoR)

### Technical Prerequisites
- [x] package.json exists with TypeScript installed
- [x] Project structure defined
- [x] Build system requirements understood
- [x] Team agreed on coding standards

### Competitor Analysis Completed
- [x] **SC2 Galaxy Script**: Weak typing, proprietary language documented
- [x] **W3 JASS**: No type safety, error-prone documented
- [x] **Unity C#**: Strong typing but tied to Unity ecosystem documented
- [x] **Our Advantage**: Full TypeScript with strict mode, modern tooling

### Tool Evaluation Documented
- [x] **TypeScript vs Flow**: TS chosen for ecosystem, community support
- [x] **Strict Mode Options**: All strict flags evaluated and enabled
- [x] **TSC vs ESBuild vs SWC**: Build tool performance compared
- [x] **Path Mapping**: Module resolution strategies assessed
- [x] **Linting Tools**: ESLint with TypeScript strict rules selected
- [x] **Formatting Tools**: Prettier chosen for consistent code style
- [x] **Testing Framework**: Jest with ts-jest for TypeScript testing

### Legal Risk Assessment
- [x] TypeScript license reviewed (Apache-2.0 - safe)
- [x] Type definition licenses checked (@types packages)
- [x] No proprietary type systems used
- [x] Open source typing strategy confirmed

### CI/CD Requirements Defined
- [x] Mandatory PR validation gates identified
- [x] Test coverage thresholds established
- [x] Code quality metrics defined
- [x] Branch protection rules documented

## 📊 Definition of Done (DoD)

### Core TypeScript Configuration
- [x] tsconfig.json configured with ALL strict mode flags enabled
- [x] Path aliases working (@engine, @formats, @gameplay, @ui, @utils, @types, @tests)
- [x] No TypeScript errors in codebase (0 errors required)
- [x] Type definitions created (global.d.ts, assets.d.ts, babylon-extensions.d.ts)
- [x] Branded types and utility types implemented
- [x] Build succeeds with strict checks
- [x] IDE IntelliSense working properly (< 500ms response time)
- [x] vite-tsconfig-paths integrated for path resolution

### Linting & Formatting Standards
- [x] ESLint configured with TypeScript strict rules
- [x] Prettier integrated for consistent code formatting
- [x] ESLint-Prettier integration configured (no conflicts)
- [x] VS Code settings configured for auto-format on save
- [x] Format scripts added (format, format:check, lint:fix)
- [x] **Zero ESLint warnings allowed** in codebase
- [x] **Zero Prettier formatting violations** allowed

### Testing Requirements
- [x] Jest configured with TypeScript support (ts-jest)
- [x] Type safety unit tests implemented (minimum 8 tests)
- [x] Test setup with proper mocking configured
- [x] Path alias resolution working in tests
- [x] Coverage collection configured
- [x] **Test Coverage Thresholds Established**:
  - **Phase 0 (Bootstrap)**: 0% (foundation only)
  - **Phase 1 (Core Engine)**: 40% minimum
  - **Phase 2 (Features)**: 60% minimum
  - **Phase 3 (Production)**: 75% minimum
  - **Critical Paths**: 90% minimum (auth, game state, networking)

### CI/CD Pipeline (MANDATORY FOR ALL PRs)
- [x] GitHub Actions workflow created (.github/workflows/ci.yml)
- [x] **Mandatory Quality Gates** (ALL must pass to merge):
  1. ✅ **Type Check**: `npm run typecheck` - Zero TypeScript errors
  2. ✅ **Lint Check**: `npm run lint` - Zero ESLint warnings/errors
  3. ✅ **Format Check**: `npm run format:check` - Zero Prettier violations
  4. ✅ **Unit Tests**: `npm run test` - All tests passing
  5. ✅ **Coverage Check**: Coverage thresholds met for current phase
  6. ✅ **Build Check**: `npm run build` - Production build succeeds
- [x] Quality gate job requiring all checks to pass
- [x] Branch protection rules enforcing CI/CD checks
- [x] **PR Merge Requirements**:
  - All CI checks must be green (no bypassing)
  - At least 1 code review approval
  - All conversations resolved
  - Branch up-to-date with target branch
  - No merge commits (rebase or squash only)

### Documentation & Developer Experience
- [x] TypeScript conventions documented
- [x] Path alias usage examples provided
- [x] Type utility documentation created
- [x] CI/CD setup guide documented
- [x] VS Code recommended extensions list
- [x] Contributing guidelines updated with validation requirements

### Progressive Coverage Requirements
**Each PR must maintain or improve coverage** based on phase:

| Phase | Statements | Branches | Functions | Lines | Enforcement |
|-------|-----------|----------|-----------|-------|-------------|
| **Phase 0** | 0% | 0% | 0% | 0% | Collect only |
| **Phase 1** | 40% | 35% | 40% | 40% | PR blocked if decreases |
| **Phase 2** | 60% | 55% | 60% | 60% | PR blocked if decreases |
| **Phase 3+** | 75% | 70% | 75% | 75% | PR blocked if decreases |

**Critical Path Coverage** (enforced from Phase 1):
- Authentication: 90%
- Game State Management: 90%
- Networking/Multiplayer: 90%
- Asset Loading: 85%
- Error Handling: 85%

### Code Quality Metrics (Enforced by CI/CD)
- [x] **TypeScript Strict Mode**: 100% coverage (no opt-outs)
- [x] **No 'any' types**: except explicitly documented cases
- [x] **ESLint Rules**: Zero violations allowed
- [x] **Prettier Formatting**: 100% compliance
- [x] **Import Organization**: Auto-sorted, grouped
- [x] **Type Coverage**: Monitored and reported

## 🎯 Goal
Establish a robust TypeScript configuration that enforces type safety, improves developer experience, and prevents runtime errors.

## 🔍 Competitor Analysis

### StarCraft 2 Galaxy Script
- **Type System**: Basic types, weak checking
- **IDE Support**: Limited to SC2 Editor
- **Debugging**: Console-only, no breakpoints
- **Limitations**: Proprietary, cannot use outside SC2
- **Our Advantage**: Full TypeScript with source maps, debugging

### Warcraft 3 JASS/vJASS
- **Type System**: Minimal, error-prone
- **IDE Support**: Third-party tools only
- **Debugging**: Print statements only
- **Limitations**: Ancient language, poor tooling
- **Our Advantage**: Modern language, excellent tooling

### Unity/Unreal Blueprints
- **Type System**: Visual scripting or C#/C++
- **IDE Support**: Tied to engine editor
- **Debugging**: Engine-specific tools
- **Limitations**: Platform lock-in, heavy toolchain
- **Our Advantage**: Standard web tech, lightweight

## 🛠️ Tool Evaluation

### Type Checker Comparison
| Tool | Build Speed | Type Safety | Ecosystem | Decision |
|------|-------------|-------------|-----------|----------|
| **TypeScript** | Baseline | Excellent | Massive | ✅ SELECTED |
| Flow | Faster | Good | Declining | Not chosen |
| JSDoc | Instant | Weak | Native | Fallback only |

### Compiler Performance
| Tool | Speed | Compatibility | Type Checking | Decision |
|------|-------|---------------|---------------|----------|
| **tsc** | Baseline | 100% | Full | ✅ TYPE CHECK |
| esbuild | 10-100x | 99% | None | Build only |
| swc | 20x | 95% | Basic | Alternative |

### Strict Mode Flags Analysis
| Flag | Impact | Performance | Safety | Decision |
|------|--------|-------------|--------|----------|
| strict | All below | None | High | ✅ ENABLED |
| noImplicitAny | High | None | Critical | ✅ ENABLED |
| strictNullChecks | High | Minor | Critical | ✅ ENABLED |
| noUncheckedIndexedAccess | Medium | None | High | ✅ ENABLED |

## 📝 Implementation Details

### 1. Create Main tsconfig.json
```json
{
  "compilerOptions": {
    // Language and Environment
    "target": "ES2020",
    "lib": ["ES2020", "DOM", "DOM.Iterable", "WebWorker"],
    "jsx": "react-jsx",
    "module": "ESNext",
    "moduleResolution": "bundler",

    // Strict Type Checking (ALL enabled)
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "strictBindCallApply": true,
    "strictPropertyInitialization": true,
    "noImplicitThis": true,
    "alwaysStrict": true,

    // Additional Checks
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true,
    "noImplicitOverride": true,
    "noPropertyAccessFromIndexSignature": true,

    // Module Resolution
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "forceConsistentCasingInFileNames": true,

    // Path Aliases
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@engine/*": ["./src/engine/*"],
      "@formats/*": ["./src/formats/*"],
      "@gameplay/*": ["./src/gameplay/*"],
      "@networking/*": ["./src/networking/*"],
      "@assets/*": ["./src/assets/*"],
      "@ui/*": ["./src/ui/*"],
      "@utils/*": ["./src/utils/*"],
      "@types/*": ["./src/types/*"],
      "@tests/*": ["./tests/*"]
    },

    // Emit
    "noEmit": true,
    "skipLibCheck": true,
    "allowImportingTsExtensions": true,

    // Decorators (for Colyseus)
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true,

    // Source Maps
    "sourceMap": true,
    "inlineSources": true,
    "declarationMap": true
  },

  "include": [
    "src/**/*",
    "tests/**/*",
    "vite.config.ts"
  ],

  "exclude": [
    "node_modules",
    "dist",
    "build",
    "coverage",
    "*.js",
    "**/*.spec.ts"
  ],

  "references": [
    { "path": "./tsconfig.node.json" }
  ]
}
```

### 2. Create tsconfig.node.json for Node Scripts
```json
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true,
    "strict": true
  },
  "include": [
    "vite.config.ts",
    "jest.config.ts",
    "scripts/**/*"
  ]
}
```

### 3. Create Type Definition Files
```typescript
// src/types/global.d.ts
declare global {
  interface Window {
    __EDGE_CRAFT_VERSION__: string;
    __EDGE_CRAFT_DEBUG__: boolean;
  }

  // Extend console for custom logging
  interface Console {
    engine: (...args: any[]) => void;
    gameplay: (...args: any[]) => void;
  }
}

// src/types/assets.d.ts
declare module '*.glb' {
  const url: string;
  export default url;
}

declare module '*.gltf' {
  const url: string;
  export default url;
}

declare module '*.hdr' {
  const url: string;
  export default url;
}

declare module '*.wasm' {
  const url: string;
  export default url;
}

// src/types/babylon-extensions.d.ts
import '@babylonjs/core';

declare module '@babylonjs/core' {
  interface Scene {
    metadata?: {
      edgeCraftVersion?: string;
      mapName?: string;
      playerCount?: number;
    };
  }

  interface Mesh {
    metadata?: {
      unitId?: string;
      team?: number;
      selectable?: boolean;
    };
  }
}
```

### 4. Configure Vite for TypeScript Paths
```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import tsconfigPaths from 'vite-tsconfig-paths';

export default defineConfig({
  plugins: [
    react(),
    tsconfigPaths() // Enables path aliases
  ],

  esbuild: {
    // Use esbuild for faster builds in dev
    tsconfigRaw: {
      compilerOptions: {
        jsx: 'react-jsx'
      }
    }
  }
});
```

### 5. Create Strict Type Utilities
```typescript
// src/utils/types.ts

// Branded types for type safety
export type Brand<T, B> = T & { __brand: B };

export type PlayerId = Brand<string, 'PlayerId'>;
export type UnitId = Brand<string, 'UnitId'>;
export type BuildingId = Brand<string, 'BuildingId'>;

// Utility types
export type DeepReadonly<T> = {
  readonly [P in keyof T]: T[P] extends object
    ? DeepReadonly<T[P]>
    : T[P];
};

export type Nullable<T> = T | null;
export type Optional<T> = T | undefined;

// Result type for error handling
export type Result<T, E = Error> =
  | { ok: true; value: T }
  | { ok: false; error: E };

// Exhaustive check helper
export function assertNever(value: never): never {
  throw new Error(`Unhandled value: ${value}`);
}
```

### 6. Configure Type Checking Scripts
```json
// package.json
{
  "scripts": {
    "typecheck": "tsc --noEmit",
    "typecheck:watch": "tsc --noEmit --watch",
    "typecheck:build": "tsc --noEmit --pretty",
    "typecheck:strict": "tsc --noEmit --strict --noUnusedLocals --noUnusedParameters"
  }
}
```

### 7. IDE Configuration
```json
// .vscode/settings.json additions
{
  "typescript.tsdk": "node_modules/typescript/lib",
  "typescript.enablePromptUseWorkspaceTsdk": true,
  "typescript.preferences.importModuleSpecifier": "shortest",
  "typescript.preferences.includePackageJsonAutoImports": "on",
  "typescript.suggest.autoImports": true,
  "typescript.updateImportsOnFileMove.enabled": "always",
  "typescript.suggest.completeFunctionCalls": true,

  // Format on save
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  }
}
```

## ✅ Validation

### Type Safety Tests
```typescript
// tests/typescript/type-safety.test.ts
import { PlayerId, UnitId } from '@/utils/types';

// This should cause TypeScript error
const testTypeSafety = () => {
  const playerId: PlayerId = 'player1' as PlayerId;
  const unitId: UnitId = 'unit1' as UnitId;

  // @ts-expect-error - Cannot assign PlayerId to UnitId
  const wrongAssignment: UnitId = playerId;

  // @ts-expect-error - Cannot use string directly
  const invalidId: PlayerId = 'player2';
};

// Test strict null checks
const testStrictNull = () => {
  let value: string | null = null;

  // @ts-expect-error - Object is possibly 'null'
  console.log(value.length);

  if (value !== null) {
    console.log(value.length); // OK
  }
};
```

### Validation Commands
```bash
# 1. Run type checking
npm run typecheck
# Should complete with no errors

# 2. Test path aliases
echo "import { Engine } from '@engine/core';" > test.ts
npm run typecheck
# Should resolve correctly

# 3. Test strict mode
echo "let x: any = 5;" > strict-test.ts
npm run typecheck
# Should error on 'any' type

# 4. Build test
npm run build
# Should complete successfully
```

## 📊 Success Metrics
- Zero TypeScript errors in strict mode
- All path aliases resolving correctly
- IDE IntelliSense response time < 500ms
- Type checking completes in < 10 seconds
- 100% of code has explicit types (no 'any')

## 🚨 Common Issues & Solutions

### Issue: Path aliases not working
```bash
# Install vite-tsconfig-paths
npm install --save-dev vite-tsconfig-paths

# Restart IDE and dev server
```

### Issue: Type errors in dependencies
```typescript
// Create type shims for untyped packages
declare module 'untyped-package' {
  const value: any;
  export default value;
}
```

### Issue: Slow type checking
```bash
# Use incremental compilation
{
  "compilerOptions": {
    "incremental": true,
    "tsBuildInfoFile": ".tsbuildinfo"
  }
}
```

## 📚 Resources
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [TypeScript Deep Dive](https://basarat.gitbook.io/typescript/)
- [Strict Mode Guide](https://www.typescriptlang.org/tsconfig#strict)
- [Path Mapping](https://www.typescriptlang.org/docs/handbook/module-resolution.html#path-mapping)

## 🔄 Dependencies
- PRP 0.1: Development Environment Setup

## ⏱️ Estimated Time
- **Implementation**: 3-4 hours
- **Testing**: 2 hours
- **Migration**: 2-4 hours (existing code)

## 👥 Assigned To
- Senior TypeScript Developer

## 🚀 GitHub CI/CD Integration

### Recommended GitHub Actions for TypeScript
```yaml
# .github/workflows/typescript.yml
name: TypeScript Quality

on:
  pull_request:
    paths:
      - '**.ts'
      - '**.tsx'
      - 'tsconfig.json'

jobs:
  type-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: TypeScript Strict Check
        run: npm run typecheck

      - name: Check for 'any' types
        run: |
          ! grep -r "any" --include="*.ts" --include="*.tsx" src/ || {
            echo "::error::Found 'any' types in codebase"
            exit 1
          }

      - name: Generate Type Coverage Report
        run: npx type-coverage --detail
```

### Benefits of CI/CD for TypeScript
- ✅ Enforces strict typing in PRs
- ✅ Prevents type regressions
- ✅ Automated type coverage reports
- ✅ Catches configuration drift
- ✅ Ensures consistent type safety

## 🔒 Pull Request Validation Requirements

### Mandatory Checks (Cannot Merge Without)
Every pull request MUST pass these automated checks before merging:

#### 1. Type Validation (`npm run typecheck`)
- **Requirement**: Zero TypeScript errors
- **Enforcement**: CI job fails if any errors detected
- **Rationale**: Prevents type-related runtime errors
- **Common Failures**:
  - Implicit `any` types
  - Null/undefined safety violations
  - Missing type definitions
  - Path alias resolution errors

#### 2. Lint Validation (`npm run lint`)
- **Requirement**: Zero ESLint warnings and errors
- **Enforcement**: max-warnings=0 flag enforced
- **Rationale**: Ensures code quality and consistency
- **Common Failures**:
  - Unused variables/imports
  - Missing return types
  - Unsafe type assertions
  - React hooks violations

#### 3. Format Validation (`npm run format:check`)
- **Requirement**: 100% Prettier compliance
- **Enforcement**: CI fails on any formatting differences
- **Rationale**: Consistent code style across team
- **Fix**: Run `npm run format` locally before committing

#### 4. Unit Test Validation (`npm run test`)
- **Requirement**: All tests passing
- **Enforcement**: Jest exit code 0 required
- **Rationale**: Prevents regressions
- **Common Failures**:
  - Broken test cases
  - Mock configuration issues
  - Async timing problems

#### 5. Coverage Validation (`npm run test -- --coverage`)
- **Requirement**: Meet phase-specific thresholds
- **Enforcement**: Jest coverage gates
- **Rationale**: Ensure adequate test coverage
- **Progressive Thresholds**:
  - Phase 0: 0% (collect baseline)
  - Phase 1: 40%/35%/40%/40% (statements/branches/functions/lines)
  - Phase 2: 60%/55%/60%/60%
  - Phase 3+: 75%/70%/75%/75%

#### 6. Build Validation (`npm run build`)
- **Requirement**: Production build succeeds
- **Enforcement**: Vite build exit code 0 required
- **Rationale**: Catch build-time issues early
- **Common Failures**:
  - Import resolution errors
  - Asset loading problems
  - Terser minification issues

### Quality Gate Summary
```yaml
Required Status Checks:
  ✅ Lint Check (must pass)
  ✅ TypeScript Type Check (must pass)
  ✅ Unit Tests (must pass)
  ✅ Build Check (must pass)
  ✅ Quality Gate (depends on all above)
```

### Coverage Evolution Strategy

#### Phase 0: Bootstrap (Current)
- **Goal**: Establish foundation and tooling
- **Coverage**: 0% (collect baseline metrics)
- **Focus**: Infrastructure, CI/CD, type safety
- **PR Requirement**: Coverage collection enabled, no blocking

#### Phase 1: Core Engine (Next)
- **Goal**: Implement core game engine features
- **Coverage Target**: 40% overall, 90% critical paths
- **Focus**: Scene management, rendering, input handling
- **PR Requirement**:
  - New code must have 60% coverage
  - Overall coverage cannot decrease
  - Critical paths must be 90%+

#### Phase 2: Features & Polish
- **Goal**: Complete game features
- **Coverage Target**: 60% overall, 90% critical paths
- **Focus**: Gameplay mechanics, UI, networking
- **PR Requirement**:
  - New code must have 75% coverage
  - Overall coverage cannot decrease

#### Phase 3: Production Ready
- **Goal**: Production hardening
- **Coverage Target**: 75% overall, 95% critical paths
- **Focus**: Edge cases, error handling, optimization
- **PR Requirement**:
  - New code must have 85% coverage
  - Zero tolerance for coverage decrease

### Developer Workflow

#### Before Creating PR
```bash
# 1. Format code
npm run format

# 2. Fix linting issues
npm run lint:fix

# 3. Run type check
npm run typecheck

# 4. Run tests with coverage
npm run test -- --coverage

# 5. Build project
npm run build

# 6. Verify all checks pass
npm run typecheck && npm run lint && npm run format:check && npm run test && npm run build
```

#### PR Creation Checklist
- [ ] All files formatted with Prettier
- [ ] No ESLint warnings or errors
- [ ] Zero TypeScript errors
- [ ] All tests passing locally
- [ ] Coverage thresholds met
- [ ] Production build succeeds
- [ ] Branch rebased on latest main
- [ ] Commit messages follow conventional commits
- [ ] PR description explains changes
- [ ] Screenshots/videos for UI changes

### Bypassing Checks (NEVER ALLOWED)
- ❌ **No force-push to bypass CI**
- ❌ **No admin override of required checks**
- ❌ **No disabling ESLint rules without review**
- ❌ **No @ts-ignore without documentation**
- ❌ **No coverage decrease without justification**

### Emergency Hotfix Process
Even for production hotfixes:
1. All CI checks must pass
2. Coverage cannot decrease
3. Two approvals required (vs one for normal PRs)
4. Post-merge validation required

## 📈 Progress Tracking

### Configuration Complete ✅
- [x] tsconfig.json created with all strict flags
- [x] tsconfig.node.json for build tools
- [x] Path aliases configured and working
- [x] Type definitions added (global, assets, babylon)
- [x] Strict mode enabled (100% coverage)
- [x] Zero type errors in codebase
- [x] vite-tsconfig-paths integrated
- [x] Source maps configured

### Linting & Formatting Complete ✅
- [x] ESLint configured with TypeScript rules
- [x] Prettier integrated
- [x] ESLint-Prettier integration
- [x] VS Code settings configured
- [x] Format scripts added
- [x] Zero lint warnings/errors
- [x] Zero format violations

### Testing Framework Complete ✅
- [x] Jest configured with ts-jest
- [x] Type safety tests implemented (8 tests)
- [x] Test setup with mocking
- [x] Coverage collection configured
- [x] Coverage thresholds defined
- [x] Path aliases working in tests

### CI/CD Pipeline Complete ✅
- [x] GitHub Actions workflow created
- [x] Type check job configured
- [x] Lint check job configured
- [x] Format check job configured
- [x] Test job with coverage configured
- [x] Build check job configured
- [x] Quality gate job configured
- [x] All checks passing on main branch
- [x] Branch protection rules documented

### Documentation Complete ✅
- [x] TypeScript conventions documented in PRP
- [x] Path alias usage examples provided
- [x] Type utility documentation created
- [x] CI/CD validation requirements documented
- [x] Coverage evolution strategy defined
- [x] Developer workflow guide created
- [x] PR checklist provided

### Next Steps (Future PRPs)
- [ ] Increase coverage thresholds to Phase 1 levels (40%)
- [ ] Add critical path coverage enforcement
- [ ] Implement type coverage monitoring
- [ ] Add performance regression testing
- [ ] Configure automated dependency updates
- [ ] Add bundle size monitoring