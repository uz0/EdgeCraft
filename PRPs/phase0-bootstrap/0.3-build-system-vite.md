name: "PRP 0.3: Build System (Vite) Configuration"
phase: 0
parallel: true
description: |
  Configure Vite as the build system with optimized settings for development and production builds.

## 📋 Definition of Ready (DoR)

### Technical Prerequisites
- [ ] TypeScript configuration complete
- [ ] Project dependencies installed
- [ ] Development requirements documented
- [ ] Performance targets defined

### Competitor Analysis Completed
- [ ] **SC2 Editor Build**: 5+ minute compile times, no HMR documented
- [ ] **W3 World Editor Build**: Manual save/test cycle, no live reload documented
- [ ] **Unity Build Pipeline**: 30+ second compile for changes documented
- [ ] **Our Advantage**: <1s HMR, instant feedback loop

### Tool Evaluation Documented
- [ ] **Vite vs Webpack**: Vite 10-100x faster cold start measured
- [ ] **Vite vs Parcel**: Vite better ecosystem support confirmed
- [ ] **Vite vs ESBuild**: Vite more feature-complete assessed
- [ ] **Rollup vs ESBuild**: Rollup better for production builds

### Legal Risk Assessment
- [ ] Vite license reviewed (MIT - safe)
- [ ] Rollup license reviewed (MIT - safe)
- [ ] Plugin licenses audited (all MIT/Apache)
- [ ] No proprietary build tools used

## 📊 Definition of Done (DoD)
- [ ] Vite configuration complete
- [ ] Development server starts in <3 seconds
- [ ] HMR working with <1 second updates
- [ ] Production build optimized (<10MB initial)
- [ ] Build time <30 seconds
- [ ] Code splitting configured
- [ ] Asset optimization working
- [ ] Environment variables supported
- [ ] Source maps configured

## 🎯 Goal
Set up a fast, efficient build system that provides excellent developer experience and optimized production builds.

## 🔍 Competitor Analysis

### StarCraft 2 Galaxy Editor
- **Build Time**: 5+ minutes for map compilation
- **Hot Reload**: Non-existent, full restart required
- **Asset Pipeline**: Manual import, no optimization
- **Debugging**: Limited to print statements
- **Our Advantage**: Instant HMR, optimized asset pipeline

### Warcraft 3 World Editor
- **Build Time**: 2-3 minutes for large maps
- **Hot Reload**: Save → Close → Test cycle
- **Asset Pipeline**: Manual MDX/BLP conversion
- **Testing**: In-game only, no unit tests
- **Our Advantage**: Sub-second updates, automated testing

### Unity/Unreal Engine
- **Build Time**: 30s-5min depending on changes
- **Hot Reload**: Limited, often requires play mode restart
- **Asset Pipeline**: Heavy, requires import processing
- **Bundle Size**: 100MB+ minimum
- **Our Advantage**: <1s HMR, <10MB initial bundle

## 🛠️ Tool Evaluation

### Build Tool Comparison
| Tool | Cold Start | HMR Speed | Bundle Size | Ecosystem | Decision |
|------|------------|-----------|-------------|-----------|----------|
| **Vite** | <3s | <100ms | Optimal | Excellent | ✅ SELECTED |
| Webpack | 10-30s | 1-3s | Good | Massive | Legacy |
| Parcel | 5-10s | 200ms | Good | Limited | Alternative |
| ESBuild | <1s | N/A | Basic | Growing | Build-only |

### Production Bundler Analysis
| Tool | Tree Shaking | Code Splitting | Compression | Decision |
|------|--------------|----------------|-------------|----------|
| **Rollup** | Excellent | Excellent | Plugin-based | ✅ SELECTED |
| ESBuild | Basic | Limited | Built-in | Fast alternative |
| SWC | Good | Good | Plugin-based | Future option |

### Development Experience Features
| Feature | Vite | Webpack | Parcel | Impact |
|---------|------|---------|--------|--------|
| ES Modules | Native | Transpiled | Transpiled | Faster |
| Dependency Pre-bundling | ✅ | ❌ | Partial | Critical |
| TypeScript Support | Native | Plugin | Native | DX |
| React Fast Refresh | ✅ | Plugin | ✅ | Essential |

## 📝 Implementation Details

### 1. Install Vite and Plugins
```bash
npm install --save-dev \
  vite@^5.0.0 \
  @vitejs/plugin-react@^4.2.0 \
  vite-tsconfig-paths@^4.2.0 \
  vite-plugin-checker@^0.6.0 \
  vite-plugin-compression@^0.5.1 \
  vite-plugin-pwa@^0.17.0 \
  rollup-plugin-visualizer@^5.9.0 \
  @types/node@^20.0.0
```

### 2. Create Comprehensive Vite Configuration
```typescript
// vite.config.ts
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';
import tsconfigPaths from 'vite-tsconfig-paths';
import checker from 'vite-plugin-checker';
import compression from 'vite-plugin-compression';
import { VitePWA } from 'vite-plugin-pwa';
import { visualizer } from 'rollup-plugin-visualizer';
import path from 'path';

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), '');

  return {
    // Base configuration
    base: '/',
    publicDir: 'public',

    // Plugins
    plugins: [
      // React with Fast Refresh
      react({
        fastRefresh: true,
        babel: {
          plugins: [
            ['@babel/plugin-proposal-decorators', { legacy: true }]
          ]
        }
      }),

      // TypeScript path resolution
      tsconfigPaths(),

      // Type checking in separate process
      checker({
        typescript: true,
        eslint: {
          lintCommand: 'eslint "./src/**/*.{ts,tsx}"',
          dev: { logLevel: ['error'] }
        }
      }),

      // Gzip/Brotli compression
      compression({
        verbose: true,
        disable: false,
        threshold: 10240,
        algorithm: 'gzip',
        ext: '.gz'
      }),

      // PWA support
      VitePWA({
        registerType: 'autoUpdate',
        includeAssets: ['favicon.ico', 'robots.txt'],
        manifest: {
          name: 'Edge Craft',
          short_name: 'EdgeCraft',
          theme_color: '#1a1a1a',
          icons: [
            {
              src: '/icon-192.png',
              sizes: '192x192',
              type: 'image/png'
            }
          ]
        }
      }),

      // Bundle analyzer (production only)
      mode === 'production' && visualizer({
        open: true,
        filename: 'dist/stats.html',
        gzipSize: true,
        brotliSize: true
      })
    ].filter(Boolean),

    // Path resolution
    resolve: {
      alias: {
        '@': path.resolve(__dirname, './src'),
        '@engine': path.resolve(__dirname, './src/engine'),
        '@formats': path.resolve(__dirname, './src/formats'),
        '@gameplay': path.resolve(__dirname, './src/gameplay'),
        '@networking': path.resolve(__dirname, './src/networking'),
        '@assets': path.resolve(__dirname, './src/assets'),
        '@ui': path.resolve(__dirname, './src/ui'),
        '@utils': path.resolve(__dirname, './src/utils'),
        '@types': path.resolve(__dirname, './src/types')
      },
      extensions: ['.mjs', '.js', '.ts', '.jsx', '.tsx', '.json']
    },

    // Development server
    server: {
      port: parseInt(env.PORT) || 3000,
      host: true, // Allow external connections
      open: true, // Open browser on start

      // HTTPS for development (required for some WebGL features)
      https: mode === 'development' ? {
        key: './certificates/localhost-key.pem',
        cert: './certificates/localhost.pem'
      } : false,

      // Hot Module Replacement
      hmr: {
        overlay: true,
        protocol: 'ws'
      },

      // CORS configuration
      cors: true,

      // Proxy configuration for backend
      proxy: {
        '/api': {
          target: 'http://localhost:2567',
          changeOrigin: true,
          secure: false
        },
        '/colyseus': {
          target: 'ws://localhost:2567',
          ws: true,
          changeOrigin: true
        }
      },

      // File watching
      watch: {
        ignored: ['**/node_modules/**', '**/dist/**']
      }
    },

    // Build configuration
    build: {
      // Output directory
      outDir: 'dist',
      assetsDir: 'assets',

      // Source maps
      sourcemap: mode === 'development' ? 'inline' : true,

      // Minification
      minify: mode === 'production' ? 'terser' : false,
      terserOptions: {
        compress: {
          drop_console: mode === 'production',
          drop_debugger: mode === 'production',
          pure_funcs: mode === 'production' ? ['console.log'] : []
        },
        mangle: {
          safari10: true
        }
      },

      // Target browsers
      target: 'es2020',

      // Chunk size warnings
      chunkSizeWarningLimit: 1000, // KB

      // Rollup options
      rollupOptions: {
        input: {
          main: path.resolve(__dirname, 'index.html')
        },

        output: {
          // Manual chunks for better caching
          manualChunks: (id) => {
            // Babylon.js in separate chunk
            if (id.includes('@babylonjs')) {
              return 'babylon';
            }

            // React in separate chunk
            if (id.includes('react') || id.includes('react-dom')) {
              return 'react';
            }

            // Networking libraries
            if (id.includes('colyseus') || id.includes('socket')) {
              return 'networking';
            }

            // Node modules vendor chunk
            if (id.includes('node_modules')) {
              return 'vendor';
            }
          },

          // Asset file naming
          assetFileNames: (assetInfo) => {
            const info = assetInfo.name.split('.');
            const ext = info[info.length - 1];

            if (/\.(png|jpe?g|svg|gif|tiff|bmp|ico)$/i.test(assetInfo.name)) {
              return `assets/images/[name]-[hash][extname]`;
            }

            if (/\.(woff2?|ttf|otf|eot)$/i.test(assetInfo.name)) {
              return `assets/fonts/[name]-[hash][extname]`;
            }

            return `assets/[name]-[hash][extname]`;
          },

          // Chunk file naming
          chunkFileNames: 'js/[name]-[hash].js',

          // Entry file naming
          entryFileNames: 'js/[name]-[hash].js'
        },

        // External dependencies (if any)
        external: [],

        // Tree shaking
        treeshake: {
          moduleSideEffects: false,
          propertyReadSideEffects: false,
          tryCatchDeoptimization: false
        }
      },

      // CSS code splitting
      cssCodeSplit: true,

      // Asset inlining threshold
      assetsInlineLimit: 4096, // 4KB

      // Manifest for asset tracking
      manifest: true,

      // SSR options (for future)
      ssrManifest: false,

      // Report compressed size
      reportCompressedSize: true,

      // Empty outDir on build
      emptyOutDir: true
    },

    // Optimization
    optimizeDeps: {
      // Pre-bundle heavy dependencies
      include: [
        '@babylonjs/core',
        '@babylonjs/loaders',
        '@babylonjs/materials',
        'react',
        'react-dom'
      ],

      // Exclude from pre-bundling
      exclude: ['@babylonjs/inspector'],

      // Force optimization in dev
      force: mode === 'development'
    },

    // Environment variables
    define: {
      __APP_VERSION__: JSON.stringify(process.env.npm_package_version),
      __BUILD_TIME__: JSON.stringify(new Date().toISOString()),
      __DEV__: mode === 'development'
    },

    // CSS configuration
    css: {
      modules: {
        localsConvention: 'camelCase',
        scopeBehaviour: 'local',
        generateScopedName: mode === 'production'
          ? '[hash:base64:5]'
          : '[name]__[local]__[hash:base64:5]'
      },

      preprocessorOptions: {
        scss: {
          additionalData: `@import "@/styles/variables.scss";`
        }
      },

      devSourcemap: true
    },

    // JSON handling
    json: {
      namedExports: true,
      stringify: false
    },

    // Asset handling
    assetsInclude: [
      '**/*.gltf',
      '**/*.glb',
      '**/*.hdr',
      '**/*.ktx2',
      '**/*.wasm'
    ],

    // Worker configuration
    worker: {
      format: 'es',
      plugins: [tsconfigPaths()]
    },

    // Preview server (for production testing)
    preview: {
      port: 4173,
      strictPort: false,
      open: true
    },

    // Logging
    logLevel: 'info',
    clearScreen: true,

    // Experimental features
    experimental: {
      renderBuiltUrl(filename, { hostType }) {
        if (hostType === 'js') {
          return { relative: true };
        }
        return { relative: false };
      }
    }
  };
});
```

### 3. Create Environment Files
```bash
# .env.development
NODE_ENV=development
VITE_API_URL=http://localhost:2567
VITE_WS_URL=ws://localhost:2567
VITE_DEBUG=true
VITE_LOG_LEVEL=debug

# .env.production
NODE_ENV=production
VITE_API_URL=https://api.edgecraft.game
VITE_WS_URL=wss://api.edgecraft.game
VITE_DEBUG=false
VITE_LOG_LEVEL=error

# .env.staging
NODE_ENV=staging
VITE_API_URL=https://staging.edgecraft.game
VITE_WS_URL=wss://staging.edgecraft.game
VITE_DEBUG=true
VITE_LOG_LEVEL=info
```

### 4. Create Build Scripts
```json
// package.json
{
  "scripts": {
    // Development
    "dev": "vite",
    "dev:https": "vite --https",
    "dev:host": "vite --host",
    "dev:debug": "DEBUG=vite:* vite",

    // Building
    "build": "vite build",
    "build:dev": "vite build --mode development",
    "build:staging": "vite build --mode staging",
    "build:prod": "vite build --mode production",
    "build:analyze": "vite build --mode production && open dist/stats.html",

    // Preview
    "preview": "vite preview",
    "preview:prod": "vite build --mode production && vite preview",

    // Optimization
    "optimize": "vite optimize",
    "clean": "rm -rf dist .vite node_modules/.vite",

    // Utilities
    "size": "size-limit",
    "why": "vite why"
  }
}
```

### 5. Create Local HTTPS Certificates
```bash
# scripts/create-certificates.sh
#!/bin/bash

mkdir -p certificates

# Generate local certificates for HTTPS dev
openssl req -x509 -newkey rsa:2048 \
  -keyout certificates/localhost-key.pem \
  -out certificates/localhost.pem \
  -days 365 \
  -nodes \
  -subj "/CN=localhost"

echo "Certificates created in ./certificates/"
```

## ✅ Validation

### Performance Tests
```bash
# 1. Development server startup
time npm run dev
# Should start in < 3 seconds

# 2. HMR speed test
# Make a change to App.tsx
# Should update in < 1 second

# 3. Production build
time npm run build
# Should complete in < 30 seconds

# 4. Bundle size check
npm run build:analyze
# Initial bundle should be < 10MB

# 5. Lighthouse audit
npm run build && npm run preview
# Open Chrome DevTools > Lighthouse
# Should score > 90 for performance
```

### Build Output Verification
```bash
# Check build output structure
tree -L 2 dist/

# Expected structure:
# dist/
# ├── assets/
# │   ├── images/
# │   ├── fonts/
# │   └── ...
# ├── js/
# │   ├── main-[hash].js
# │   ├── babylon-[hash].js
# │   ├── react-[hash].js
# │   └── vendor-[hash].js
# ├── index.html
# ├── manifest.json
# └── stats.html
```

## 📊 Success Metrics
- Dev server starts in < 3 seconds
- HMR updates in < 1 second
- Production build < 30 seconds
- Initial bundle size < 10MB
- Code splitting working (4-5 chunks)
- Gzip compression reducing size by >60%
- Lighthouse performance score > 90

## 🚨 Common Issues & Solutions

### Issue: Slow dev server startup
```javascript
// Solution: Optimize dependencies
optimizeDeps: {
  force: true,
  include: ['heavy-dependency']
}
```

### Issue: Large bundle size
```bash
# Analyze bundle
npm run build:analyze

# Enable compression
npm install vite-plugin-compression
```

### Issue: CORS errors in development
```javascript
// Add to server config
server: {
  cors: {
    origin: '*',
    credentials: true
  }
}
```

## 📚 Resources
- [Vite Documentation](https://vitejs.dev/)
- [Rollup Documentation](https://rollupjs.org/)
- [Vite Plugin Catalog](https://github.com/vitejs/awesome-vite)
- [Performance Best Practices](https://web.dev/vitals/)

## 🔄 Dependencies
- PRP 0.2: TypeScript Configuration

## ⏱️ Estimated Time
- **Implementation**: 3-4 hours
- **Testing**: 2 hours
- **Optimization**: 2 hours

## 👥 Assigned To
- Build Engineer / Senior Developer

## 🚀 GitHub CI/CD Integration

### Recommended GitHub Actions for Vite Builds
```yaml
# .github/workflows/build.yml
name: Build Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Production
        run: npm run build

      - name: Analyze Bundle Size
        run: |
          npx vite-bundle-visualizer
          npm run validate:bundle

      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './lighthouserc.json'
          uploadArtifacts: true

      - name: Deploy Preview
        if: github.event_name == 'pull_request'
        uses: netlify/actions/cli@master
        with:
          args: deploy --dir=dist --alias=pr-${{ github.event.pull_request.number }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Comment Build Stats
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const stats = JSON.parse(fs.readFileSync('dist/stats.json'));
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Build Stats
              - Bundle Size: ${stats.bundleSize}
              - Load Time: ${stats.loadTime}
              - Lighthouse Score: ${stats.lighthouse}
              - Preview: https://pr-${context.issue.number}.edgecraft.netlify.app`
            });
```

### Benefits of CI/CD for Vite
- ✅ Automated build verification
- ✅ Bundle size tracking and alerts
- ✅ Performance regression prevention
- ✅ Automatic preview deployments
- ✅ Lighthouse score monitoring

## 📈 Progress Tracking
- [ ] Vite installed and configured
- [ ] Development server working
- [ ] HMR functioning
- [ ] Production build optimized
- [ ] Code splitting configured
- [ ] Performance targets met
- [ ] GitHub Actions build pipeline configured