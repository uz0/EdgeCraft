#!/bin/bash

###
# Edge Craft Pre-Commit Hook
#
# Runs before each git commit to ensure code quality and legal compliance.
#
# Checks:
# 1. TypeScript type checking (strict mode)
# 2. ESLint linting (0 errors, 0 warnings)
# 3. Unit tests (all passing)
# 4. Package licenses (compatible)
# 5. Asset attribution (complete)
#
# To bypass (emergencies only): git commit --no-verify
###

set -e  # Exit on first error

echo ""
echo "üöÄ Edge Craft Pre-Commit Validation"
echo "===================================="
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Check if we're in a git repository
if [ ! -d .git ]; then
  echo -e "${RED}‚ùå Not a git repository${NC}"
  exit 1
fi

# Function to print step
step() {
  echo -e "${CYAN}[$1/5] $2${NC}"
}

# Function to handle success
success() {
  echo -e "${GREEN}‚úÖ $1${NC}"
  echo ""
}

# Function to handle failure
fail() {
  echo -e "${RED}‚ùå $1${NC}"
  echo -e "${YELLOW}üí° Hint: $2${NC}"
  echo ""
  exit 1
}

# 1. TypeScript Type Checking
step 1 "TypeScript Type Checking"
if npm run typecheck > /dev/null 2>&1; then
  success "TypeScript: 0 errors"
else
  fail "TypeScript errors detected" "Run 'npm run typecheck' to see errors"
fi

# 2. ESLint Linting
step 2 "ESLint Linting"
if npm run lint > /dev/null 2>&1; then
  success "ESLint: 0 errors, 0 warnings"
else
  fail "ESLint errors detected" "Run 'npm run lint' to see errors, or 'npm run lint:fix' to auto-fix"
fi

# 3. Unit Tests
step 3 "Unit Tests"
if npm run test:unit > /dev/null 2>&1; then
  success "Unit tests: All passing"
else
  fail "Unit test failures detected" "Run 'npm run test:unit' to see failing tests"
fi

# 4. Package Licenses
step 4 "Package Licenses"
if node scripts/validation/PackageLicenseValidator.cjs > /dev/null 2>&1; then
  success "Packages: All licenses compatible"
else
  fail "Package license issues detected" "Run 'node scripts/validation/PackageLicenseValidator.cjs' for details"
fi

# 5. Asset Attribution
step 5 "Asset Attribution"
if node scripts/validation/AssetCreditsValidator.cjs > /dev/null 2>&1; then
  success "Assets: All properly attributed"
else
  echo -e "${YELLOW}‚ö†Ô∏è  Asset attribution warnings${NC}"
  echo -e "${YELLOW}   Run 'node scripts/validation/AssetCreditsValidator.cjs' for details${NC}"
  echo -e "${YELLOW}   Fix before production release${NC}"
  echo ""
  # Don't fail on warnings, just warn
fi

echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo -e "${GREEN}üéâ Ready to commit${NC}"
echo ""

exit 0
