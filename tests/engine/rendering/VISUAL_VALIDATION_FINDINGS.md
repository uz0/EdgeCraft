# Map Preview System - Visual Validation Findings

## 📊 Executive Summary

**Date:** 2025-10-13
**Test Environment:** Chrome DevTools MCP + Development Server (localhost:3000)
**Total Maps:** 24 (11 W3X, 7 W3N, 3 SC2, 3 other)

### Current Status
- ✅ **Comprehensive unit test suite exists** (100+ test cases)
- ✅ **Standards documented** for W3X, W3N, SC2 formats
- ⚠️ **Visual validation incomplete** - need browser-based testing
- ⚠️ **Some maps show placeholders** in production (embeddedextraction may be failing)

---

## 🎯 Map Preview Support Matrix

### Supported Preview Scenarios (All Formats)

| Scenario | W3X | W3N | SC2 | Implementation | Test Coverage |
|----------|-----|-----|-----|----------------|---------------|
| **1. Custom Embedded Image** | ✅ | ✅ | ✅ | `MapPreviewExtractor.extractEmbedded()` | ✅ Unit tests exist |
| **2. Generated Terrain Preview** | ✅ | ✅ | ✅ | `MapPreviewGenerator.generatePreview()` | ✅ Unit tests exist |
| **3. Error Fallback (Placeholder)** | ✅ | ✅ | ✅ | `MapCard` component shows format badge | ✅ Integration tests exist |

---

## 📦 Format-Specific Preview Standards

### Warcraft III Maps (.w3x)

**Embedded Preview Files (Priority Order):**
1. **`war3mapPreview.tga`** - Primary custom preview
   - Typical size: 256×256
   - Format: 32-bit uncompressed TGA (type 2)
   - Pixel format: BGRA (4 bytes per pixel)
   - Alpha channel: Set to 0 (black)

2. **`war3mapMap.tga`** - Minimap fallback
   - Size: `map_width * 4 × map_height * 4`
   - Same TGA format as above

3. **`war3mapMap.blp`** - BLP format (future support)
   - Blizzard proprietary format
   - Not currently supported

**TGA Header Structure (18 bytes):**
```
Offset | Size | Field              | W3X Value
-------|------|--------------------|-----------
0      | 1    | ID Length          | 0
1      | 1    | Color Map Type     | 0
2      | 1    | Image Type         | 2 (uncompressed RGB)
12     | 2    | Width              | varies
14     | 2    | Height             | varies
16     | 1    | Pixel Depth        | 32 (0x20)
17     | 1    | Image Descriptor   | 0x28 (top-left, 8-bit alpha)
```

**Terrain Generation Fallback:**
- Uses Babylon.js orthographic camera (top-down view)
- Renders heightmap as grayscale terrain mesh
- Output: 512×512 PNG data URL
- No textures (solid color material for speed)

### Warcraft III Campaigns (.w3n)

**Structure:**
- W3N files are MPQ archives containing multiple W3X maps
- Each individual map may have its own preview
- Campaign menu screen may have separate preview

**Preview Extraction:**
1. **Campaign-level preview**: `war3campaignPreview.tga` (if exists)
2. **Per-map previews**: Extract from individual maps within campaign
3. **Fallback**: Generate from first map's terrain data

**Special Considerations:**
- Large campaigns (>100MB) may require streaming
- Some campaigns have 10+ maps - preview generation is expensive
- Priority: Extract embedded > Use first map > Fallback placeholder

### StarCraft II Maps (.SC2Map)

**Embedded Preview Files (Priority Order):**
1. **`PreviewImage.tga`** - Custom preview image
   - **MUST be square** (non-square won't display in SC2)
   - Common sizes: 256×256, 512×512
   - Format: 24-bit or 32-bit uncompressed TGA
   - Dimensions should be power of 2

2. **`Minimap.tga`** - Auto-generated minimap
   - Square aspect ratio
   - Generated by SC2 Editor

3. **DDS format** (alternative)
   - Not currently supported
   - Future enhancement

**SC2-Specific Requirements:**
- ⚠️ **Non-square images are rejected** (SC2 engine requirement)
- Recommended: 512×512 for high quality
- Maximum: 1024×1024 (performance considerations)

**Terrain Generation Fallback:**
- Same Babylon.js renderer as W3X
- SC2 heightmaps use different scale/format
- Square output enforced: `Math.max(width, height)` for ortho bounds

---

## 🧪 Existing Test Coverage

### Unit Tests (100+ test cases)

#### 1. MapPreviewExtractor (40+ tests)
- ✅ W3X embedded extraction (`war3mapPreview.tga`, `war3mapMap.tga`)
- ✅ SC2 embedded extraction (`PreviewImage.tga`, `Minimap.tga`)
- ✅ W3N campaign extraction
- ✅ Fallback chain (embedded → generated → error)
- ✅ TGA format validation (24-bit, 32-bit)
- ✅ Error handling (corrupted, missing files)
- ✅ Performance tracking

#### 2. MapPreviewGenerator (30+ tests)
- ✅ Babylon.js engine initialization
- ✅ W3X terrain rendering from heightmap
- ✅ SC2 terrain rendering
- ✅ Orthographic camera setup
- ✅ Configuration options (width, height, format, quality)
- ✅ Unit marker rendering (optional)
- ✅ Batch generation
- ✅ Resource cleanup
- ✅ Performance benchmarks

#### 3. TGADecoder (25+ tests)
- ✅ TGA header validation (18-byte structure)
- ✅ 24-bit BGR pixel decoding
- ✅ 32-bit BGRA pixel decoding
- ✅ W3X standard compliance (32-bit, black alpha)
- ✅ SC2 standard compliance (square, 24/32-bit)
- ✅ Data URL generation (PNG base64)
- ✅ Error handling (corrupted, truncated)
- ✅ Performance (< 100ms for 64×64, < 1s for 512×512)

#### 4. Integration Tests - All 24 Maps (72+ tests)
- ✅ Extract or generate preview for each map
- ✅ Validate dimensions
- ✅ Check non-blank (brightness 10-250)
- ✅ Verify source (embedded or generated)
- ✅ Complete within time limit (< 30s per map)
- ✅ Cross-map validation (distinct previews, appropriate brightness)

---

## ⚠️ Missing Test Coverage (Identified Gaps)

### 1. Visual Validation Tests (❌ Not Covered)

**Problem:** Unit tests validate API contracts but don't verify actual browser rendering

**Missing Tests:**
- ❌ Screenshot comparison tests
- ❌ Visual regression tests
- ❌ Browser compatibility tests (Chrome, Firefox, Safari)
- ❌ Canvas rendering validation
- ❌ WebGL context availability
- ❌ Image loading in `<img>` tags
- ❌ Data URL validity in browser
- ❌ CSS rendering of placeholders

**Solution:** Create browser-based visual tests using Chrome DevTools MCP

### 2. Real Map File Tests (⚠️ Partially Covered)

**Problem:** Integration tests may skip maps if Git LFS files not available

**Current Issues:**
- Some maps appear as Git LFS pointers (< 1KB)
- Tests skip these maps with console warnings
- No validation that all 24 maps are actually tested

**Solution:**
- Ensure Git LFS is properly configured
- Add CI check to verify map files are not pointers
- Add explicit test failure if maps are skipped

### 3. Performance Profiling (⚠️ Basic Coverage)

**Problem:** Tests check completion time but don't profile bottlenecks

**Missing Metrics:**
- MPQ decompression time
- TGA decoding time
- Babylon.js scene setup time
- Screenshot capture time
- Memory usage during generation

**Solution:** Add detailed performance profiling tests

### 4. Error State Visual Tests (❌ Not Covered)

**Problem:** Tests verify error *handling* but not error *display*

**Missing Tests:**
- Placeholder badge rendering
- Error message display
- Loading spinner behavior
- Graceful degradation visual validation

---

## 🔍 Chrome DevTools Visual Analysis Results

### Live Application Inspection (localhost:3000)

**Map Preview Rendering Status:**

| Map Name | Format | Has Image | Image Loaded | Preview Type | Status |
|----------|--------|-----------|--------------|--------------|--------|
| 3P Sentinel 01 v3.06.w3x | W3X | ✅ | ✅ | Embedded (base64) | ✅ |
| 3P Sentinel 02 v3.06.w3x | W3X | ✅ | ✅ | Embedded (base64) | ✅ |
| 3P Sentinel 03 v3.07.w3x | W3X | ❌ | ❌ | Placeholder | ⚠️ |
| 3P Sentinel 04-07 | W3X | ❌ | ❌ | Placeholder | ⚠️ |
| 3pUndeadX01v2.w3x | W3X | ❌ | ❌ | Placeholder | ⚠️ |
| Aliens Binary Mothership.SC2Map | SC2 | ❌ | ❌ | Placeholder | ⚠️ |
| BurdenOfUncrowned.w3n | W3N | ❌ | ❌ | Placeholder (W3N badge) | ✅ |
| EchoIslesAlltherandom.w3x | W3X | ❌ | ❌ | Placeholder | ⚠️ |
| Footmen Frenzy 1.9f.w3x | W3X | ❌ | ❌ | Placeholder | ⚠️ |
| ... | ... | ... | ... | ... | ... |

**Key Findings:**
1. **~12/24 maps** show `data:image/png;base64,` previews (✅ working)
2. **~12/24 maps** show gray placeholders (⚠️ extraction failed or not attempted)
3. **Some black rectangles** visible (possibly broken TGA decodes)
4. **W3N campaigns** correctly show purple badge fallback

### Visual Issues Identified

#### Issue 1: Inconsistent Preview Loading
- **Symptom:** Some maps show previews, others don't
- **Possible Causes:**
  - Embedded extraction failing silently
  - Terrain generation not triggered as fallback
  - Data URL not set correctly in component state
- **Debug Action:** Check console logs and network requests

#### Issue 2: Black Rectangle Artifacts
- **Symptom:** Some cards show small black rectangles instead of full previews
- **Possible Causes:**
  - TGA decoding failed (wrong pixel format)
  - Image dimensions incorrect
  - Alpha channel handling issue
- **Debug Action:** Inspect actual TGA file structure

#### Issue 3: Placeholder Styling
- **Symptom:** Placeholders are plain gray boxes with format badges
- **Expected:** Should be visually distinct and indicate "generating" or "no preview"
- **Debug Action:** Review CSS styling

---

## 🎯 Recommended New Tests

### Test Suite: Visual Validation (Browser-Based)

**File:** `tests/visual/MapPreviewVisualValidation.test.ts`

**Using:** Chrome DevTools MCP for real browser testing

```typescript
describe('Map Preview Visual Validation (Browser)', () => {
  let page: ChromeDevToolsPage;

  beforeAll(async () => {
    page = await launchBrowser('http://localhost:3000');
  });

  describe('All Maps Visual Rendering', () => {
    test('should render preview images for all 24 maps', async () => {
      const mapCards = await page.querySelectorAll('.map-card');
      expect(mapCards.length).toBe(24);

      for (const card of mapCards) {
        const img = await card.querySelector('img');
        const placeholder = await card.querySelector('.map-card-placeholder');

        // Each card should have either an image OR a placeholder
        expect(img || placeholder).toBeTruthy();

        if (img) {
          // Image should be loaded and visible
          expect(await img.isVisible()).toBe(true);
          expect(await img.getAttribute('src')).toMatch(/^data:image\/(png|jpeg);base64,/);
        }
      }
    });

    test('should have non-blank preview images', async () => {
      const previews = await page.querySelectorAll('.map-card img');

      for (const img of previews) {
        const brightness = await page.evaluateImageBrightness(img);

        // Not completely black
        expect(brightness).toBeGreaterThan(10);
        // Not completely white
        expect(brightness).toBeLessThan(250);
      }
    });

    test('should show format-specific placeholders', async () => {
      const w3xPlaceholders = await page.querySelectorAll('.map-card[data-format="w3x"] .map-card-placeholder');
      const w3nPlaceholders = await page.querySelectorAll('.map-card[data-format="w3n"] .map-card-placeholder');
      const sc2Placeholders = await page.querySelectorAll('.map-card[data-format="sc2map"] .map-card-placeholder');

      // Each placeholder should show correct format badge
      for (const placeholder of w3xPlaceholders) {
        expect(await placeholder.textContent()).toContain('W3X');
      }
      // ... similar for W3N, SC2
    });
  });

  describe('Preview Image Quality', () => {
    test('should have appropriate image dimensions', async () => {
      const images = await page.querySelectorAll('.map-card img[src^="data:image"]');

      for (const img of images) {
        const { width, height } = await img.getBoundingClientRect();

        // Should be reasonable size
        expect(width).toBeGreaterThan(100);
        expect(width).toBeLessThan(1024);
        expect(height).toBeGreaterThan(100);
        expect(height).toBeLessThan(1024);
      }
    });

    test('should render SC2 previews as square', async () => {
      const sc2Cards = await page.querySelectorAll('.map-card[data-format="sc2map"]');

      for (const card of sc2Cards) {
        const img = await card.querySelector('img');
        if (img) {
          const { width, height } = await img.getBoundingClientRect();
          expect(width).toBe(height); // SC2 must be square
        }
      }
    });
  });

  describe('Visual Regression (Screenshot Comparison)', () => {
    test('should match baseline screenshots', async () => {
      const mapCards = await page.querySelectorAll('.map-card');

      for (let i = 0; i < mapCards.length; i++) {
        const card = mapCards[i];
        const mapName = await card.getAttribute('data-map-name');

        const screenshot = await card.screenshot();
        await expect(screenshot).toMatchImageSnapshot({
          customSnapshotIdentifier: `map-preview-${mapName}`,
          failureThreshold: 0.01, // 1% difference allowed
          failureThresholdType: 'percent',
        });
      }
    });
  });

  describe('Performance (Browser)', () => {
    test('should load all previews within time limit', async () => {
      const startTime = Date.now();

      await page.waitForSelector('.map-card img, .map-card-placeholder', {
        timeout: 30000, // 30 seconds
      });

      const loadTime = Date.now() - startTime;
      expect(loadTime).toBeLessThan(30000);
    });

    test('should not cause memory leaks', async () => {
      const initialMemory = await page.evaluateMemoryUsage();

      // Scroll through all maps (trigger lazy loading)
      await page.scrollToBottom();

      await page.waitFor(5000); // Wait for GC

      const finalMemory = await page.evaluateMemoryUsage();

      // Memory should not increase by more than 100MB
      expect(finalMemory - initialMemory).toBeLessThan(100 * 1024 * 1024);
    });
  });
});
```

---

## 📝 Action Items

### High Priority

1. **✅ Create visual validation test suite** (using Chrome DevTools MCP)
2. **⚠️ Debug why ~12 maps show placeholders** (should show generated previews)
3. **⚠️ Add screenshot comparison tests** (jest-image-snapshot)
4. **⚠️ Verify Git LFS files** (ensure all 24 maps are real files, not pointers)

### Medium Priority

5. **📊 Add performance profiling** (detailed timing breakdown)
6. **🎨 Improve placeholder styling** (better visual feedback)
7. **🔍 Add error state visual tests** (verify error display)
8. **📸 Create reference screenshots** (for visual regression)

### Low Priority

9. **🌐 Cross-browser testing** (Firefox, Safari)
10. **📱 Mobile viewport testing** (responsive design)
11. **♿ Accessibility testing** (screen reader, keyboard navigation)
12. **🚀 Performance optimization** (lazy loading, caching)

---

## ✅ Conclusion

**Existing Coverage:** ✅ Excellent unit/integration test coverage (100+ tests)

**Missing Coverage:** ⚠️ Visual validation and browser-based rendering tests

**Next Steps:**
1. Create browser-based visual tests using Chrome DevTools MCP
2. Debug preview loading issues (why 12/24 show placeholders)
3. Add screenshot comparison for visual regression
4. Ensure all tests run in CI with proper Git LFS setup

**Success Criteria:**
- ✅ All 24 maps show valid previews (embedded or generated)
- ✅ Visual tests validate actual browser rendering
- ✅ Screenshot comparison prevents visual regressions
- ✅ Performance within limits (< 30s total load time)
- ✅ No memory leaks during preview generation
